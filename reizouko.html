<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>ğŸ  ãŠã†ã¡å†·è”µåº«</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{font-family:'Noto Sans JP','Hiragino Kaku Gothic ProN',sans-serif;background:#f4f1ec;color:#1a1a1a;min-height:100vh}
input,select,textarea,button{font-family:inherit}
#app{max-width:520px;margin:0 auto;min-height:100vh}
.hdr{background:#1a1a1a;color:#fff;position:sticky;top:0;z-index:100}
.h-top{display:flex;align-items:center;justify-content:space-between;padding:12px 16px 8px}
.logo{font-size:17px;font-weight:700}.logo-sub{font-size:10px;color:#888;letter-spacing:.1em}
.abadge{background:#e53935;color:#fff;font-size:11px;font-weight:600;padding:5px 10px;border-radius:20px;cursor:pointer;animation:pulse 2s infinite;display:none}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
nav{display:flex;border-top:1px solid #333}
.nb{flex:1;background:transparent;border:none;color:#888;cursor:pointer;padding:9px 4px;font-size:10px;display:flex;flex-direction:column;align-items:center;gap:2px;transition:all .2s}
.nb.act{color:#fff;background:#333}
.ni{font-size:17px}
main{padding:14px 14px 100px}
.fade{animation:fi .25s ease}
@keyframes fi{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.card{background:#fff;border-radius:14px;box-shadow:0 1px 6px rgba(0,0,0,.06)}
.stitle{font-size:13px;font-weight:700;color:#555;margin:14px 0 8px}
.empty{text-align:center;padding:36px 20px;color:#bbb;font-size:13px;line-height:1.8}
.srow{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:18px}
.sc{padding:13px 8px;text-align:center;cursor:pointer}
.sn{font-size:24px;font-weight:700}.sl{font-size:11px;color:#aaa;margin-top:2px}
.fgrid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.fc{padding:13px 8px;text-align:center;cursor:pointer;border:2px solid;transition:transform .15s}
.fc:active{transform:scale(.97)}
.fi2{width:38px;height:38px;border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:20px;margin:0 auto 7px}
.fn{font-size:11px;font-weight:600}.fcnt{font-size:19px;font-weight:700;margin-top:3px}
.fw{font-size:10px;color:#e53935;margin-top:3px}
.ur{display:flex;align-items:center;gap:11px;background:#fff;border-radius:12px;padding:11px 13px;margin-bottom:7px;box-shadow:0 1px 5px rgba(0,0,0,.06);border-left:3px solid #e53935}
.eb{font-size:11px;font-weight:600;padding:3px 9px;border-radius:20px;flex-shrink:0;white-space:nowrap}
.frow{display:flex;gap:7px;overflow-x:auto;padding-bottom:4px;margin-bottom:10px;-ms-overflow-style:none;scrollbar-width:none}
.frow::-webkit-scrollbar{display:none}
.fbtn{padding:6px 13px;border-radius:20px;border:1.5px solid #e0dbd2;background:#fff;font-size:12px;cursor:pointer;white-space:nowrap;transition:all .2s}
.fbtn.fa{background:#1a1a1a;border-color:#1a1a1a;color:#fff}
.si{width:100%;padding:9px 13px;border:1.5px solid #e8e4dc;border-radius:11px;font-size:14px;background:#fff;margin-bottom:11px;outline:none}
.si:focus{border-color:#aaa}
.ir{display:flex;align-items:center;gap:10px;background:#fff;border-radius:12px;padding:11px 13px;box-shadow:0 1px 4px rgba(0,0,0,.05)}
.ilist{display:flex;flex-direction:column;gap:7px}
.iname{font-size:14px;font-weight:600}
.imeta{font-size:11px;color:#888;display:flex;gap:4px;flex-wrap:wrap;margin-top:2px}
/* qty controls */
.qctrl{display:flex;align-items:center;flex-shrink:0}
.qbtn{width:30px;height:30px;border:1.5px solid #e0dbd2;background:#fff;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;transition:background .15s;line-height:1;flex-shrink:0}
.qbtn:first-child{border-radius:8px 0 0 8px}
.qbtn:last-child{border-radius:0 8px 8px 0}
.qbtn:active{background:#f0ede8}
.qnum{min-width:34px;text-align:center;border-top:1.5px solid #e0dbd2;border-bottom:1.5px solid #e0dbd2;height:30px;font-size:13px;font-weight:600;background:#fafaf8;display:flex;align-items:center;justify-content:center;padding:0 4px}
.bp{background:#1a1a1a;color:#fff;border:none;border-radius:12px;padding:11px 18px;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;justify-content:center;gap:5px}
.bp:active{background:#333;transform:translateY(1px)}
.bp:disabled{opacity:.5;cursor:not-allowed}
.bg{background:#f5f2ed;color:#555;border:none;border-radius:12px;padding:10px 16px;font-size:14px;cursor:pointer}
.bg:active{background:#ede9e2}
.xb{background:none;border:none;color:#ccc;font-size:22px;cursor:pointer;padding:2px 4px;flex-shrink:0;line-height:1}
.xb:active{color:#e57373}
.fab{position:fixed;bottom:76px;left:50%;transform:translateX(-50%);background:#1a1a1a;color:#fff;border:none;border-radius:28px;padding:13px 26px;font-size:15px;font-weight:600;cursor:pointer;box-shadow:0 4px 18px rgba(0,0,0,.28);z-index:50;white-space:nowrap}
.fab:active{transform:translateX(-50%) translateY(2px)}
.ov{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:200;display:flex;align-items:flex-end;justify-content:center}
.mo{background:#fff;border-radius:20px 20px 0 0;padding:22px 18px;width:100%;max-width:520px;max-height:90vh;overflow-y:auto}
.mt{font-size:17px;font-weight:700;margin-bottom:16px}
.lbl{font-size:12px;color:#888;font-weight:600;display:block;margin-bottom:5px}
.field{margin-bottom:13px}
.fi3{width:100%;padding:10px 13px;border:1.5px solid #e8e4dc;border-radius:10px;font-size:14px;background:#fafaf8;outline:none;transition:border .2s}
.fi3:focus{border-color:#aaa;background:#fff}
.pw{display:flex;flex-wrap:wrap;gap:7px;margin-bottom:13px}
.pc{padding:7px 11px;border-radius:11px;border:1.5px solid #e0dbd2;background:#fff;color:#333;cursor:pointer;font-size:12px;transition:all .2s;display:flex;align-items:center;gap:3px}
.pc.sel{background:#1a1a1a;border-color:#1a1a1a;color:#fff}
.pc.hot{background:#fff8e1}
.pc.used{background:#f5f5f5}
.stabs{display:flex;gap:4px;margin-bottom:14px;background:#ede9e2;border-radius:11px;padding:4px}
.stb{flex:1;padding:7px 2px;border:none;background:transparent;font-size:11px;cursor:pointer;border-radius:8px;transition:all .2s;color:#888;white-space:nowrap}
.stb.sa{background:#fff;color:#1a1a1a;font-weight:700;box-shadow:0 1px 4px rgba(0,0,0,.1)}
.sbox{background:#fff;border-radius:13px;padding:14px;margin-bottom:14px;box-shadow:0 1px 5px rgba(0,0,0,.06)}
.pb{font-size:11px;font-weight:600;padding:2px 8px;border-radius:20px;margin-left:5px}
.fu{background:#fff;border-radius:15px;padding:26px;text-align:center;cursor:pointer;border:2px dashed #ddd;margin-bottom:14px;display:flex;flex-direction:column;align-items:center}
.fi4{background:#fff;border-radius:11px;padding:11px 13px;display:flex;align-items:flex-start;gap:11px;box-shadow:0 1px 4px rgba(0,0,0,.05);margin-bottom:7px}
.ma{width:100%;min-height:200px;padding:13px;border:1.5px solid #e8e4dc;border-radius:13px;font-size:15px;line-height:1.9;background:#fff;outline:none;resize:vertical}
.dc{background:#fff;border-radius:13px;padding:14px;margin-bottom:11px;box-shadow:0 1px 5px rgba(0,0,0,.06)}
.mr{display:flex;gap:10px;padding:7px 0;border-bottom:1px solid #fafaf8;align-items:flex-start}
.lb{text-align:center;padding:36px 20px;color:#aaa}
.sp{width:34px;height:34px;border:3px solid #eee;border-top-color:#1a1a1a;border-radius:50%;animation:sp2 1s linear infinite;margin:0 auto 11px}
@keyframes sp2{to{transform:rotate(360deg)}}
.err{background:#fce4ec;border-radius:11px;padding:13px;color:#c62828;font-size:13px}
.rbadge{font-size:10px;background:#e8f5e9;color:#2e7d32;padding:2px 7px;border-radius:20px;font-weight:600;margin-left:5px}
.hov{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:300;overflow-y:auto;padding:18px 14px 36px}
.hbox{background:#fff;border-radius:18px;padding:22px 18px;max-width:480px;margin:0 auto}
.hs{display:flex;gap:13px;align-items:flex-start;margin-bottom:18px}
.hn{width:30px;height:30px;background:#1a1a1a;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;flex-shrink:0}
/* receipt check row */
.rci{display:flex;align-items:center;gap:10px;padding:9px 0;border-bottom:1px solid #f5f5f5;cursor:pointer}
.rck{width:22px;height:22px;border-radius:6px;border:2px solid #ccc;background:#fff;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .2s}
.rck.on{border-color:#1a1a1a;background:#1a1a1a}
</style>
</head>
<body>
<div id="app">
  <div class="hdr">
    <div class="h-top">
      <div><div class="logo">ğŸ  ãŠã†ã¡å†·è”µåº«</div><div class="logo-sub">FAMILY FRIDGE MANAGER</div></div>
      <div style="display:flex;gap:7px;align-items:center">
        <div id="abadge" class="abadge" onclick="switchTab('items')"></div>
        <button class="bg" style="padding:5px 11px;font-size:12px" onclick="showHelp()">â“ ä½¿ã„æ–¹</button>
      </div>
    </div>
    <nav>
      <button class="nb act" id="nb-home"     onclick="switchTab('home')">    <span class="ni">ğŸ </span><span>ãƒ›ãƒ¼ãƒ </span></button>
      <button class="nb"     id="nb-items"    onclick="switchTab('items')">   <span class="ni">ğŸ§Š</span><span>åœ¨åº«</span></button>
      <button class="nb"     id="nb-shopping" onclick="switchTab('shopping')"><span class="ni">ğŸ›’</span><span>è²·ã„ç‰©</span></button>
      <button class="nb"     id="nb-meals"    onclick="switchTab('meals')">   <span class="ni">ğŸ³</span><span>çŒ®ç«‹</span></button>
    </nav>
  </div>
  <main id="mc"></main>
</div>

<div id="hov" class="hov" style="display:none" onclick="hideHelp()">
  <div class="hbox" onclick="event.stopPropagation()">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px">
      <div style="font-size:18px;font-weight:700">ğŸ“– ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</div>
      <button class="xb" onclick="hideHelp()" style="font-size:26px;color:#888">Ã—</button>
    </div>
    <div class="hs"><div class="hn">1</div><div><b>ğŸ§Š é£Ÿæã‚’ç™»éŒ²</b><br><span style="font-size:13px;color:#555;line-height:1.7">ã€Œåœ¨åº«ã€â†’ã€Œï¼‹é£Ÿæã‚’è¿½åŠ ã€ã€‚ã‚«ãƒ†ã‚´ãƒªã‚’é¸ã¶ã¨é£Ÿæãƒœã‚¿ãƒ³ãŒä¸¦ã³ã¾ã™ã€‚ã‚¿ãƒƒãƒ—ã™ã‚‹ã ã‘ã§æ•°é‡ãƒ»æœŸé™ãŒè‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™ï¼</span></div></div>
    <div class="hs"><div class="hn">2</div><div><b>â•â– æ•°é‡ã‚’ã™ãå¤‰ãˆã‚‹</b><br><span style="font-size:13px;color:#555;line-height:1.7">åœ¨åº«ä¸€è¦§ã®ã€Œâˆ’ã€ã€Œï¼‹ã€ãƒœã‚¿ãƒ³ã§æ•°é‡ã‚’å¤‰æ›´ã€‚0ã«ãªã‚‹ã¨å‰Šé™¤ç¢ºèªãŒå‡ºã¾ã™ã€‚æ–™ç†ã§ä½¿ã£ãŸã‚‰ã™ãã€Œâˆ’ã€ã‚’æŠ¼ã™ã ã‘ï¼</span></div></div>
    <div class="hs"><div class="hn">3</div><div><b>ğŸ§¾ ãƒ¬ã‚·ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã‚€</b><br><span style="font-size:13px;color:#555;line-height:1.7">ã€Œè²·ã„ç‰©ã€â†’ã€Œãƒ¬ã‚·ãƒ¼ãƒˆã€ã‚¿ãƒ–ã€‚è²·ã„ç‰©ã®ãƒ¬ã‚·ãƒ¼ãƒˆã‚’æ’®å½±ã™ã‚‹ã¨AIãŒé£Ÿæã‚’è‡ªå‹•èªè­˜ã€‚ç¢ºèªã—ã¦ã‹ã‚‰ä¸€æ‹¬ç™»éŒ²ã§ãã¾ã™ï¼</span></div></div>
    <div class="hs"><div class="hn">4</div><div><b>ğŸ“¸ ãƒãƒ©ã‚·ã§ãŠå¾—æƒ…å ±</b><br><span style="font-size:13px;color:#555;line-height:1.7">ã€Œè²·ã„ç‰©ã€â†’ã€Œãƒãƒ©ã‚·ã€ã‚¿ãƒ–ã€‚ãƒãƒ©ã‚·ã‚’æ’®å½±ã™ã‚‹ã¨AIãŒå®‰ã„å•†å“ã‚’åˆ†æã—ã¦ã€è²·ã„ç‰©ãƒªã‚¹ãƒˆã«è¿½åŠ ã§ãã¾ã™ã€‚</span></div></div>
    <div class="hs"><div class="hn">5</div><div><b>ğŸ³ AIçŒ®ç«‹</b><br><span style="font-size:13px;color:#555;line-height:1.7">ã€ŒçŒ®ç«‹ã€ã‚¿ãƒ–ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã ã‘ã€‚æœŸé™ã®è¿‘ã„é£Ÿæã‚’å„ªå…ˆã—ãŸ3æ—¥åˆ†ã®æœæ˜¼å¤•ã®çŒ®ç«‹ã‚’AIãŒææ¡ˆã—ã¾ã™ã€‚</span></div></div>
    <div style="background:#f0fdf4;border-radius:11px;padding:13px;font-size:13px;line-height:1.7">ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•ä¿å­˜ã€‚URLã‚’å®¶æ—ã«LINEã§é€ã‚Œã°å…±æœ‰ã§ãã¾ã™ï¼</div>
    <button class="bp" style="width:100%;margin-top:18px" onclick="hideHelp()">ã¨ã˜ã‚‹</button>
  </div>
</div>

<script>
// â•â•â•â•â•â• CONSTANTS â•â•â•â•â•â•
const FRIDGES=[
  {id:1,name:"å†·è”µåº« A",icon:"ğŸ§Š",color:"#4fc3f7",dark:"#0288d1"},
  {id:2,name:"å†·è”µåº« B",icon:"â„ï¸", color:"#81c784",dark:"#388e3c"},
  {id:3,name:"å†·è”µåº« C",icon:"ğŸ«™", color:"#ffb74d",dark:"#f57c00"},
];
const CATS=[
  {id:"vegetable",label:"é‡èœãƒ»æœç‰©",icon:"ğŸ¥¦"},{id:"meat",label:"è‚‰ãƒ»é­š",icon:"ğŸ¥©"},
  {id:"dairy",label:"ä¹³è£½å“",icon:"ğŸ¥›"},{id:"drink",label:"é£²ã¿ç‰©",icon:"ğŸ§ƒ"},
  {id:"seasoning",label:"èª¿å‘³æ–™",icon:"ğŸ§‚"},{id:"frozen",label:"å†·å‡é£Ÿå“",icon:"ğŸ§Š"},
  {id:"leftovers",label:"ä½œã‚Šç½®ã",icon:"ğŸ±"},{id:"other",label:"ãã®ä»–",icon:"ğŸ“¦"},
];
const UNITS=["å€‹","æœ¬","è¢‹","ãƒ‘ãƒƒã‚¯","g","kg","ml","L","æš","æŸ","åˆ‡ã‚Œ","äººåˆ†"];
const PRESETS={
  dairy:[{n:"ç‰›ä¹³",u:"L",q:1,e:7},{n:"åµ",u:"å€‹",q:6,e:14},{n:"ãƒ¨ãƒ¼ã‚°ãƒ«ãƒˆ",u:"å€‹",q:2,e:10},
    {n:"ãƒãƒ¼ã‚º",u:"è¢‹",q:1,e:21},{n:"ãƒã‚¿ãƒ¼",u:"å€‹",q:1,e:30},{n:"ç”Ÿã‚¯ãƒªãƒ¼ãƒ ",u:"ãƒ‘ãƒƒã‚¯",q:1,e:5},
    {n:"è±†ä¹³",u:"æœ¬",q:1,e:7},{n:"ãƒ—ãƒªãƒ³",u:"å€‹",q:3,e:7}],
  vegetable:[{n:"ã‚­ãƒ£ãƒ™ãƒ„",u:"å€‹",q:1,e:7},{n:"ã«ã‚“ã˜ã‚“",u:"æœ¬",q:3,e:14},{n:"ã»ã†ã‚Œã‚“è‰",u:"è¢‹",q:1,e:4},
    {n:"ã‚‚ã‚„ã—",u:"è¢‹",q:1,e:2},{n:"ç‰ã­ã",u:"å€‹",q:3,e:14},{n:"ãƒˆãƒãƒˆ",u:"å€‹",q:3,e:5},
    {n:"ãã‚…ã†ã‚Š",u:"æœ¬",q:3,e:5},{n:"ãƒ¬ã‚¿ã‚¹",u:"å€‹",q:1,e:5},{n:"ãƒ–ãƒ­ãƒƒã‚³ãƒªãƒ¼",u:"å€‹",q:1,e:5},
    {n:"ã˜ã‚ƒãŒã„ã‚‚",u:"å€‹",q:3,e:14},{n:"ã‚Šã‚“ã”",u:"å€‹",q:3,e:14},{n:"ãƒãƒŠãƒŠ",u:"æœ¬",q:5,e:5}],
  meat:[{n:"é¶ã‚€ã­è‚‰",u:"g",q:300,e:3},{n:"é¶ã‚‚ã‚‚è‚‰",u:"g",q:300,e:3},{n:"è±šãƒãƒ©è‚‰",u:"g",q:200,e:3},
    {n:"è±šã“ã¾è‚‰",u:"ãƒ‘ãƒƒã‚¯",q:1,e:3},{n:"ç‰›è‚‰",u:"g",q:200,e:3},{n:"ã²ãè‚‰",u:"g",q:200,e:2},
    {n:"é®­",u:"åˆ‡ã‚Œ",q:2,e:2},{n:"ã•ã°",u:"åˆ‡ã‚Œ",q:2,e:2},{n:"ãˆã³",u:"g",q:150,e:2},
    {n:"ã‚¦ã‚¤ãƒ³ãƒŠãƒ¼",u:"è¢‹",q:1,e:14},{n:"ãƒ™ãƒ¼ã‚³ãƒ³",u:"è¢‹",q:1,e:14}],
  drink:[{n:"éº¦èŒ¶",u:"L",q:2,e:3},{n:"ã‚ªãƒ¬ãƒ³ã‚¸ã‚¸ãƒ¥ãƒ¼ã‚¹",u:"L",q:1,e:7},
    {n:"ç‚­é…¸æ°´",u:"æœ¬",q:6,e:30},{n:"ã‚¹ãƒãƒ¼ãƒ„ãƒ‰ãƒªãƒ³ã‚¯",u:"æœ¬",q:2,e:30}],
  seasoning:[{n:"é†¤æ²¹",u:"æœ¬",q:1,e:90},{n:"ã¿ã‚Šã‚“",u:"æœ¬",q:1,e:90},{n:"ãƒãƒ¨ãƒãƒ¼ã‚º",u:"æœ¬",q:1,e:60},
    {n:"ã‚±ãƒãƒ£ãƒƒãƒ—",u:"æœ¬",q:1,e:60},{n:"å‘³å™Œ",u:"è¢‹",q:1,e:60},{n:"ãƒãƒ³é…¢",u:"æœ¬",q:1,e:90},
    {n:"ãƒ‰ãƒ¬ãƒƒã‚·ãƒ³ã‚°",u:"æœ¬",q:1,e:60}],
  frozen:[{n:"å†·å‡ã†ã©ã‚“",u:"å€‹",q:3,e:60},{n:"å†·å‡é¤ƒå­",u:"è¢‹",q:1,e:60},{n:"å†·å‡æè±†",u:"è¢‹",q:1,e:60},
    {n:"ã‚¢ã‚¤ã‚¹ã‚¯ãƒªãƒ¼ãƒ ",u:"å€‹",q:2,e:30},{n:"å†·å‡ãƒãƒ£ãƒ¼ãƒãƒ³",u:"è¢‹",q:1,e:60}],
  leftovers:[{n:"ã‚«ãƒ¬ãƒ¼",u:"äººåˆ†",q:2,e:2},{n:"ç…®ç‰©",u:"äººåˆ†",q:2,e:3},
    {n:"ã‚¹ãƒ¼ãƒ—",u:"äººåˆ†",q:2,e:2},{n:"ã”é£¯",u:"äººåˆ†",q:3,e:1}],
  other:[{n:"è±†è…",u:"å€‹",q:2,e:5},{n:"ã“ã‚“ã«ã‚ƒã",u:"å€‹",q:1,e:14},
    {n:"ç´è±†",u:"ãƒ‘ãƒƒã‚¯",q:3,e:7},{n:"é£Ÿãƒ‘ãƒ³",u:"è¢‹",q:1,e:5},{n:"ã‚‚ãšã",u:"å€‹",q:3,e:14}],
};

// â•â•â•â•â•â• HELPERS â•â•â•â•â•â•
function dfn(d){const dt=new Date();dt.setDate(dt.getDate()+d);return dt.toISOString().split('T')[0]}
function dl(s){const t=new Date();t.setHours(0,0,0,0);const e=new Date(s);e.setHours(0,0,0,0);return Math.round((e-t)/86400000)}
function ec(d){if(d<0)return{bg:"#b71c1c",tx:"#fff"};if(d===0)return{bg:"#e53935",tx:"#fff"};if(d<=2)return{bg:"#ff6f00",tx:"#fff"};if(d<=5)return{bg:"#f9a825",tx:"#fff"};return{bg:"#e8f5e9",tx:"#2e7d32"}}
function el(d){if(d<0)return`${Math.abs(d)}æ—¥è¶…éï¼`;if(d===0)return"ä»Šæ—¥ã¾ã§ï¼";if(d===1)return"æ˜æ—¥ã¾ã§";return`${d}æ—¥`}
function gc(id){return CATS.find(c=>c.id===id)||CATS[7]}
function gf(id){return FRIDGES.find(f=>f.id===id)||FRIDGES[0]}
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}
function uid(){return Date.now()+Math.floor(Math.random()*9999)}

// â•â•â•â•â•â• STATE â•â•â•â•â•â•
const S={
  tab:'home',
  items:[
    {id:1,name:"ç‰›ä¹³",   fridgeId:1,category:"dairy",   qty:1,unit:"L",   expiry:dfn(2),note:""},
    {id:2,name:"åµ",     fridgeId:1,category:"dairy",   qty:6,unit:"å€‹",  expiry:dfn(5),note:""},
    {id:3,name:"è±šè‚‰",   fridgeId:1,category:"meat",    qty:1,unit:"ãƒ‘ãƒƒã‚¯",expiry:dfn(1),note:"ã—ã‚ƒã¶ã—ã‚ƒã¶ç”¨"},
    {id:4,name:"ã»ã†ã‚Œã‚“è‰",fridgeId:2,category:"vegetable",qty:1,unit:"è¢‹",expiry:dfn(3),note:""},
    {id:5,name:"ã«ã‚“ã˜ã‚“", fridgeId:2,category:"vegetable",qty:3,unit:"æœ¬",expiry:dfn(7),note:""},
    {id:6,name:"è±†è…",   fridgeId:2,category:"other",   qty:2,unit:"å€‹",  expiry:dfn(4),note:""},
    {id:7,name:"ãƒãƒ¼ã‚º",  fridgeId:3,category:"dairy",  qty:1,unit:"è¢‹",  expiry:dfn(14),note:""},
    {id:8,name:"å†·å‡ã†ã©ã‚“",fridgeId:3,category:"frozen",qty:3,unit:"å€‹", expiry:dfn(30),note:""},
    {id:9,name:"ã‚‚ã‚„ã—",  fridgeId:1,category:"vegetable",qty:1,unit:"è¢‹",expiry:dfn(0),note:""},
  ],
  shopping:[
    {id:1,name:"é£Ÿãƒ‘ãƒ³",qty:"1è¢‹",done:false},
    {id:2,name:"ãƒ¨ãƒ¼ã‚°ãƒ«ãƒˆ",qty:"2å€‹",done:false},
  ],
  memo:"",freq:{},
  fridge:null,q:"",
  addOpen:false,
  // â˜… ãƒ•ã‚©ãƒ¼ãƒ ã¯å¿…ãšS.formã§ç®¡ç†ã€‚DOMã‹ã‚‰èª­ã¿å–ã‚‰ãªã„
  form:{name:"",fridgeId:1,category:"dairy",qty:1,unit:"å€‹",expiry:dfn(7),note:""},
  addShopOpen:false,shopForm:{name:"",qty:""},
  shopTab:"list",shopSugg:null,shopLoading:false,
  flyerResult:null,flyerLoading:false,flyerPreview:null,
  receiptResult:null,receiptLoading:false,receiptPreview:null,receiptConfirm:null,
  mealPlan:null,mealLoading:false,
  pendingDelete:null,
};

// â•â•â•â•â•â• STORAGE â•â•â•â•â•â•
function save(){
  try{
    localStorage.setItem('rz3_items',JSON.stringify(S.items));
    localStorage.setItem('rz3_shop', JSON.stringify(S.shopping));
    localStorage.setItem('rz3_memo', S.memo);
    localStorage.setItem('rz3_freq', JSON.stringify(S.freq));
  }catch(e){}
}
function loadSaved(){
  try{
    const it=localStorage.getItem('rz3_items');const sh=localStorage.getItem('rz3_shop');
    const mo=localStorage.getItem('rz3_memo');const fr=localStorage.getItem('rz3_freq');
    if(it)S.items=JSON.parse(it);if(sh)S.shopping=JSON.parse(sh);
    if(mo)S.memo=mo;if(fr)S.freq=JSON.parse(fr);
  }catch(e){}
}

// â•â•â•â•â•â• RENDER â•â•â•â•â•â•
function R(){
  const urg=S.items.filter(i=>dl(i.expiry)<=3);
  const ab=document.getElementById('abadge');
  if(urg.length>0){ab.style.display='block';ab.textContent=`âš ï¸ ${urg.length}ä»¶æœŸé™æ³¨æ„`}
  else ab.style.display='none';
  ['home','items','shopping','meals'].forEach(t=>document.getElementById('nb-'+t).className='nb'+(S.tab===t?' act':''));
  const mc=document.getElementById('mc');
  if(S.tab==='home')mc.innerHTML=rHome(urg);
  else if(S.tab==='items')mc.innerHTML=rItems();
  else if(S.tab==='shopping')mc.innerHTML=rShopping();
  else if(S.tab==='meals')mc.innerHTML=rMeals();
}

function rHome(urg){
  const tot=S.items.length,pend=S.shopping.filter(s=>!s.done).length;
  let uH='';
  if(urg.length>0){
    uH='<div class="stitle">ğŸ”´ ä»Šã™ãä½¿ã†ã¹ãé£Ÿæ</div>';
    urg.forEach(i=>{const d=dl(i.expiry),c=ec(d),cat=gc(i.category),fr=gf(i.fridgeId);
      uH+=`<div class="ur"><span style="font-size:21px">${cat.icon}</span>
        <div style="flex:1"><b>${esc(i.name)}</b><div style="font-size:11px;color:#aaa">${fr.icon} ${esc(fr.name)}</div></div>
        <div class="eb" style="background:${c.bg};color:${c.tx}">${el(d)}</div></div>`;
    });
    uH+=`<button class="bp" style="width:100%;margin-top:4px;margin-bottom:6px" onclick="switchTab('meals');genMeals()">ğŸ³ ã“ã®é£Ÿæã§çŒ®ç«‹ã‚’ä½œã‚‹</button>`;
  }
  return `<div class="fade">
    <div class="srow">
      <div class="sc card" style="border-top:3px solid #4fc3f7"><div class="sn">${tot}</div><div class="sl">ç·åœ¨åº«</div></div>
      <div class="sc card" style="border-top:3px solid #e53935" onclick="switchTab('items')"><div class="sn" style="color:${urg.length?'#e53935':'inherit'}">${urg.length}</div><div class="sl">æœŸé™é–“è¿‘</div></div>
      <div class="sc card" style="border-top:3px solid #66bb6a"><div class="sn">${pend}</div><div class="sl">è²·ã„ç‰©ãƒªã‚¹ãƒˆ</div></div>
    </div>
    <div class="stitle">å†·è”µåº«ã®çŠ¶æ³</div>
    <div class="fgrid">${FRIDGES.map(f=>`<div class="fc card" style="border-color:${f.color}" onclick="setFridge(${f.id})">
      <div class="fi2" style="background:${f.color}22">${f.icon}</div>
      <div class="fn">${f.name}</div><div class="fcnt">${S.items.filter(i=>i.fridgeId===f.id).length}å“</div>
      ${S.items.filter(i=>i.fridgeId===f.id&&dl(i.expiry)<=3).length>0?`<div class="fw">âš ï¸ ${S.items.filter(i=>i.fridgeId===f.id&&dl(i.expiry)<=3).length}ä»¶</div>`:''}</div>`).join('')}
    </div>${uH}</div>`;
}

function rItems(){
  let list=S.fridge?S.items.filter(i=>i.fridgeId===S.fridge):[...S.items];
  if(S.q)list=list.filter(i=>i.name.includes(S.q)||i.note.includes(S.q));
  list.sort((a,b)=>dl(a.expiry)-dl(b.expiry));
  const iH=list.length===0?`<div class="empty">åœ¨åº«ãŒã‚ã‚Šã¾ã›ã‚“<br><small>ã€Œï¼‹ é£Ÿæã‚’è¿½åŠ ã€ã‹ã‚‰ç™»éŒ²ã—ã¦ãã ã•ã„</small></div>`
    :list.map(i=>{const d=dl(i.expiry),c=ec(d),cat=gc(i.category),fr=gf(i.fridgeId);
      // å‰Šé™¤ç¢ºèªä¸­ã®ã‚¢ã‚¤ãƒ†ãƒ ã¯ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³UIã§è¡¨ç¤º
      if(S.pendingDelete===i.id){
        return `<div class="ir" style="background:#fff3f3;border:1.5px solid #ffcdd2;flex-direction:column;align-items:stretch;gap:8px">
          <div style="font-size:13px;font-weight:600;color:#c62828">ğŸ—‘ ã€Œ${esc(i.name)}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</div>
          <div style="display:flex;gap:8px">
            <button class="bg" style="flex:1;font-size:13px;padding:8px" onclick="cancelDelete()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button style="flex:1;font-size:13px;padding:8px;background:#e53935;color:#fff;border:none;border-radius:12px;cursor:pointer;font-weight:600" onclick="confirmDelete(${i.id})">å‰Šé™¤ã™ã‚‹</button>
          </div>
        </div>`;
      }
      return `<div class="ir" style="${d<=2?'border-left:3px solid '+c.bg:''}">
        <div style="font-size:20px;width:28px;text-align:center;flex-shrink:0">${cat.icon}</div>
        <div style="flex:1;min-width:0">
          <div class="iname">${esc(i.name)}</div>
          <div class="imeta"><span style="color:${fr.dark}">${fr.icon} ${esc(fr.name)}</span>
            <span style="color:#ccc">Â·</span><span>${esc(i.unit)}</span>
            ${i.note?`<span style="color:#ccc">Â·</span><span style="color:#aaa">${esc(i.note)}</span>`:''}
          </div>
        </div>
        <div class="qctrl">
          <button class="qbtn" onclick="chQty(${i.id},-1)">âˆ’</button>
          <div class="qnum">${i.qty}</div>
          <button class="qbtn" onclick="chQty(${i.id},1)">ï¼‹</button>
        </div>
        <div class="eb" style="background:${c.bg};color:${c.tx};margin-left:6px">${el(d)}</div>
        <button class="xb" onclick="delItem(${i.id})">Ã—</button>
      </div>`;}).join('');
  return `<div class="fade">
    <div class="frow">
      <button class="fbtn ${S.fridge===null?'fa':''}" onclick="setFridge(null)">ã™ã¹ã¦</button>
      ${FRIDGES.map(f=>`<button class="fbtn ${S.fridge===f.id?'fa':''}"
        style="${S.fridge===f.id?`border-color:${f.color};background:${f.color}22;color:${f.dark}`:''}"
        onclick="setFridge(${f.id})">${f.icon} ${f.name}</button>`).join('')}
    </div>
    <input class="si" placeholder="ğŸ” é£Ÿæã‚’æ¤œç´¢..." value="${esc(S.q)}" oninput="setQ(this.value)">
    <div class="ilist">${iH}</div>
    <button class="fab" onclick="openAdd()">ï¼‹ é£Ÿæã‚’è¿½åŠ </button>
    ${S.addOpen?rAddModal():''}
  </div>`;
}

function rAddModal(){
  const f=S.form;
  const presets=(PRESETS[f.category]||[]).slice().sort((a,b)=>(S.freq[b.n]||0)-(S.freq[a.n]||0));
  const pH=presets.map(p=>{const cnt=S.freq[p.n]||0,sel=f.name===p.n;
    return `<button class="pc ${sel?'sel':cnt>=3?'hot':cnt>=1?'used':''}" onclick="selP('${esc(p.n)}','${esc(p.u)}',${p.q},${p.e})">
      ${cnt>=3?'ğŸ”¥':cnt>=1?'â­':''}${esc(p.n)}${cnt>0?`<span style="font-size:10px;opacity:.6;margin-left:2px">${cnt}å›</span>`:''}
    </button>`;}).join('');
  const cB=CATS.map(c=>`<button onclick="setFC('${c.id}')" style="padding:6px 10px;border-radius:20px;border:1.5px solid ${f.category===c.id?'#1a1a1a':'#e0dbd2'};background:${f.category===c.id?'#1a1a1a':'#fff'};color:${f.category===c.id?'#fff':'#555'};cursor:pointer;font-size:12px">${c.icon} ${c.label}</button>`).join('');
  // â˜… å†·è”µåº«ãƒœã‚¿ãƒ³ï¼šsetFF()ã§S.form.fridgeIdã‚’æ›´æ–°ã—ã¦R()ã€‚ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã¯S.form.fridgeIdã‚’è¦‹ã‚‹
  const fB=FRIDGES.map(fr=>`<button onclick="setFF(${fr.id})" style="flex:1;padding:8px 4px;border:2px solid ${f.fridgeId===fr.id?fr.color:'#e0dbd2'};border-radius:10px;background:${f.fridgeId===fr.id?fr.color+'22':'#fff'};cursor:pointer;font-size:12px;text-align:center">${fr.icon}<br><small>${fr.name}</small></button>`).join('');
  const uO=UNITS.map(u=>`<option value="${u}"${f.unit===u?' selected':''}>${u}</option>`).join('');
  return `<div class="ov" onclick="closeAdd()">
    <div class="mo" onclick="event.stopPropagation()">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
        <div class="mt" style="margin:0">é£Ÿæã‚’è¿½åŠ </div>
        <button class="xb" onclick="closeAdd()" style="font-size:26px;color:#888">Ã—</button>
      </div>
      <div class="lbl">â‘  ã‚«ãƒ†ã‚´ãƒª</div>
      <div style="display:flex;flex-wrap:wrap;gap:7px;margin-bottom:16px">${cB}</div>
      <div class="lbl">â‘¡ ã‚ˆãä½¿ã†é£Ÿæã‹ã‚‰é¸ã¶${Object.keys(S.freq).length>0?' <span style="font-size:10px;color:#aaa">ğŸ”¥å›æ•°é †</span>':''}</div>
      <div class="pw">${pH}</div>
      <div class="field"><label class="lbl">â‘¢ é£Ÿæåï¼ˆç›´æ¥å…¥åŠ›ã‚‚OKï¼‰</label>
        <input class="fi3" placeholder="ä¾‹: ãã®ä»–ã®é£Ÿæ" value="${esc(f.name)}" oninput="S.form.name=this.value"></div>
      <div class="lbl">â‘£ å†·è”µåº« â€” ç¾åœ¨ã®é¸æŠ: <b>${gf(f.fridgeId).icon} ${gf(f.fridgeId).name}</b></div>
      <div style="display:flex;gap:8px;margin-bottom:14px">${fB}</div>
      <div style="display:flex;gap:8px">
        <div class="field" style="flex:1"><label class="lbl">æ•°é‡</label>
          <input class="fi3" type="number" min="0.1" step="any" value="${f.qty}" oninput="S.form.qty=parseFloat(this.value)||1"></div>
        <div class="field" style="flex:1"><label class="lbl">å˜ä½</label>
          <select class="fi3" onchange="S.form.unit=this.value">${uO}</select></div>
      </div>
      <div class="field"><label class="lbl">æ¶ˆè²»æœŸé™</label>
        <input class="fi3" type="date" value="${f.expiry}" onchange="S.form.expiry=this.value"></div>
      <div class="field"><label class="lbl">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
        <input class="fi3" placeholder="ä¾‹: ã—ã‚ƒã¶ã—ã‚ƒã¶ç”¨" value="${esc(f.note)}" oninput="S.form.note=this.value"></div>
      <div style="display:flex;gap:8px;margin-top:6px">
        <button class="bg" style="flex:1" onclick="closeAdd()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="bp" style="flex:2" onclick="addItem()" ${!f.name.trim()?'disabled':''}>âœ… è¿½åŠ ã™ã‚‹</button>
      </div>
    </div>
  </div>`;
}

function rShopping(){
  const t=S.shopTab;let body='';
  if(t==='list'){
    const pend=S.shopping.filter(s=>!s.done).length;
    const sH=S.shopLoading?`<div class="lb"><div class="sp"></div><p>åˆ†æä¸­...</p></div>`
      :S.shopSugg&&!S.shopSugg.error?`<div class="sbox"><div style="font-size:13px;font-weight:700;margin-bottom:10px;color:#555">ğŸ¤– AIã®è³¼å…¥ææ¡ˆ</div>
        ${S.shopSugg.items.map(s=>`<div style="display:flex;align-items:flex-start;gap:10px;padding:9px 0;border-bottom:1px solid #f5f5f5">
          <div style="flex:1"><b style="font-size:13px">${esc(s.name)}</b>
            <span class="pb" style="background:${s.priority==='é«˜'?'#ffebee':s.priority==='ä¸­'?'#fff8e1':'#f1f8e9'};color:${s.priority==='é«˜'?'#c62828':s.priority==='ä¸­'?'#f57f17':'#33691e'}">${s.priority}</span>
            <div style="font-size:11px;color:#888;margin-top:1px">${esc(s.reason)}</div></div>
          <button class="bp" style="font-size:12px;padding:5px 11px;flex-shrink:0" onclick="addSugg('${esc(s.name)}')">è¿½åŠ </button>
        </div>`).join('')}</div>`
      :S.shopSugg?.error?`<div class="err">ææ¡ˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>`:'';
    const lH=S.shopping.length===0?`<div class="empty">ãƒªã‚¹ãƒˆã¯ç©ºã§ã™</div>`
      :S.shopping.map(s=>`<div class="ir" style="${s.done?'opacity:.4':''}">
          <input type="checkbox" ${s.done?'checked':''} onchange="togShop(${s.id})" style="width:20px;height:20px;cursor:pointer;flex-shrink:0">
          <div style="flex:1"><div style="font-size:14px;font-weight:600;text-decoration:${s.done?'line-through':'none'}">${esc(s.name)}</div>
            ${s.qty?`<div style="font-size:11px;color:#aaa">${esc(s.qty)}</div>`:''}
          </div><button class="xb" onclick="delShop(${s.id})">Ã—</button></div>`).join('');
    body=`<div style="display:flex;gap:8px;margin-bottom:13px">
        <button class="bp" style="flex:1" onclick="getShopSugg()" ${S.shopLoading?'disabled':''}>ğŸ¤– AIææ¡ˆ</button>
        <button class="bg" onclick="openAddShop()">ï¼‹ è¿½åŠ </button>
      </div>${sH}
      <div class="stitle">è²·ã„ç‰©ãƒªã‚¹ãƒˆï¼ˆ${pend}ä»¶æœªè³¼å…¥ï¼‰</div>
      <div class="ilist">${lH}</div>
      ${S.shopping.filter(s=>s.done).length>0?`<button class="bg" style="width:100%;margin-top:8px" onclick="clearDone()">âœ“ è³¼å…¥æ¸ˆã¿ã‚’ã‚¯ãƒªã‚¢</button>`:''}
      ${S.addShopOpen?rAddShopMo():''}`;
  }
  else if(t==='receipt'){
    let rH='';
    if(S.receiptLoading){rH=`<div class="lb"><div class="sp"></div><p>ãƒ¬ã‚·ãƒ¼ãƒˆã‚’è§£æä¸­...<br><small>é£Ÿæã‚’è‡ªå‹•èªè­˜ã—ã¦ã„ã¾ã™</small></p></div>`;}
    else if(S.receiptConfirm){
      rH=`<div class="sbox">
        <div style="font-size:13px;font-weight:700;margin-bottom:4px">ğŸ§¾ èªè­˜ã•ã‚ŒãŸé£Ÿæ</div>
        <div style="font-size:12px;color:#aaa;margin-bottom:11px">ã‚¿ãƒƒãƒ—ã§é¸æŠ/è§£é™¤ â†’ ã€Œåœ¨åº«ã«è¿½åŠ ã€ã§ä¸€æ‹¬ç™»éŒ²</div>
        ${S.receiptConfirm.map((item,i)=>{const fr=gf(item.fridgeId);
          return `<div class="rci" onclick="togRC(${i})">
            <div class="rck ${item.selected?'on':''}">${item.selected?'<span style="color:#fff;font-size:13px">âœ“</span>':''}</div>
            <div style="flex:1">
              <b style="font-size:13px">${esc(item.name)}</b>
              <span class="rbadge">${fr.icon} ${fr.name}</span>
              <div style="font-size:11px;color:#888;margin-top:1px">${item.qty}${esc(item.unit)} Â· æœŸé™: ${esc(item.expiry)}</div>
            </div>
            <button onclick="event.stopPropagation();edRC(${i})" style="padding:4px 8px;border:1px solid #e0dbd2;border-radius:8px;background:#fff;font-size:11px;cursor:pointer;flex-shrink:0">å†·è”µåº«å¤‰æ›´</button>
          </div>`;}).join('')}
        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="bg" style="flex:1" onclick="S.receiptConfirm=null;R()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button class="bp" style="flex:2" onclick="bulkAdd()">âœ… åœ¨åº«ã«è¿½åŠ  (${S.receiptConfirm.filter(i=>i.selected).length}ä»¶)</button>
        </div></div>`;
    } else if(S.receiptResult?.error){
      rH=`<div class="err">è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ¬ã‚·ãƒ¼ãƒˆãŒé®®æ˜ã«å†™ã‚‹ã‚ˆã†æ’®å½±ã—ã¦ãã ã•ã„ã€‚</div>`;
    } else {
      rH=`<div class="empty">ãƒ¬ã‚·ãƒ¼ãƒˆã‚’æ’®å½±ã™ã‚‹ã¨<br>AIãŒé£Ÿæã‚’è‡ªå‹•èªè­˜ã—ã¦<br>åœ¨åº«ã«ä¸€æ‹¬ç™»éŒ²ã—ã¾ã™<br><br><b>ğŸ“Œ æ’®å½±ã®ã‚³ãƒ„</b><br>æ˜ã‚‹ã„å ´æ‰€ã§æ–‡å­—ãŒèª­ã‚ã‚‹ã‚ˆã†<br>ã¾ã£ã™ãæ’®å½±ã—ã¦ãã ã•ã„</div>`;
    }
    body=`${!S.receiptConfirm?`<div class="fu" onclick="document.getElementById('rec-inp').click()">
        ${S.receiptPreview?`<img src="${S.receiptPreview}" style="max-height:160px;max-width:100%;border-radius:8px;object-fit:contain;margin-bottom:9px">`:''}
        <div style="font-size:34px;margin-bottom:7px">ğŸ§¾</div>
        <div style="font-size:14px;font-weight:600">${S.receiptPreview?'åˆ¥ã®å†™çœŸã«å¤‰æ›´':'ãƒ¬ã‚·ãƒ¼ãƒˆã‚’æ’®å½±ãƒ»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰'}</div>
        <div style="font-size:12px;color:#aaa;margin-top:3px">ã‚¿ãƒƒãƒ—ã—ã¦æ’®å½± or ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ</div>
      </div>
      <input type="file" id="rec-inp" accept="image/*" style="display:none" onchange="handleReceipt(this)">`:''} ${rH}`;
  }
  else if(t==='flyer'){
    const rH=S.flyerLoading?`<div class="lb"><div class="sp"></div><p>ãƒãƒ©ã‚·ã‚’è§£æä¸­...</p></div>`
      :S.flyerResult&&!S.flyerResult.error
      ?`${S.flyerResult.summary?`<div style="background:#e8f5e9;border-radius:11px;padding:11px;margin-bottom:10px;font-size:13px">ğŸ“‹ <b>æ¦‚è¦ï¼š</b>${esc(S.flyerResult.summary)}</div>`:''}
        ${S.flyerResult.bestDeal?`<div style="background:#fff8e1;border-radius:11px;padding:11px;margin-bottom:10px;font-size:13px">ğŸ† <b>æœ€ã‚‚ãŠå¾—ï¼š</b>${esc(S.flyerResult.bestDeal)}</div>`:''}
        <div class="stitle">å•†å“ãƒªã‚¹ãƒˆ</div>
        ${(S.flyerResult.items||[]).map(item=>`<div class="fi4" style="border-left:${item.recommend?'3px solid #f57c00':'3px solid transparent'}">
          <div style="flex:1">
            <div style="display:flex;align-items:center;gap:7px;flex-wrap:wrap">
              <span style="font-size:13px;font-weight:600">${esc(item.name)}</span>
              ${item.recommend?`<span style="font-size:10px;background:#fff3e0;color:#e65100;padding:2px 7px;border-radius:20px;font-weight:600">ğŸ”¥ãŠã™ã™ã‚</span>`:''}
              ${item.discount?`<span style="font-size:10px;background:#fce4ec;color:#c62828;padding:2px 7px;border-radius:20px;font-weight:600">${esc(item.discount)}</span>`:''}
            </div>
            <div style="margin-top:3px"><span style="font-size:15px;font-weight:700;color:#c62828">${esc(item.price)}</span>
              ${item.originalPrice?` <span style="font-size:11px;color:#aaa;text-decoration:line-through">${esc(item.originalPrice)}</span>`:''}</div>
            ${item.reason?`<div style="font-size:11px;color:#888;margin-top:1px">${esc(item.reason)}</div>`:''}
          </div>
          <button class="bp" style="font-size:11px;padding:5px 9px;flex-shrink:0" onclick="addFS('${esc(item.name)}')">è¿½åŠ </button>
        </div>`).join('')}`
      :S.flyerResult?.error?`<div class="err">è§£æã«å¤±æ•—ã—ã¾ã—ãŸ</div>`
      :`<div class="empty">å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨<br>AIãŒãƒãƒ©ã‚·ã‚’è§£æã—ã¦<br>ãŠå¾—ãªå•†å“ã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã™</div>`;
    body=`<div class="fu" onclick="document.getElementById('fly-inp').click()">
        ${S.flyerPreview?`<img src="${S.flyerPreview}" style="max-height:160px;max-width:100%;border-radius:8px;object-fit:contain;margin-bottom:9px">`:''}
        <div style="font-size:34px;margin-bottom:7px">ğŸ“¸</div>
        <div style="font-size:14px;font-weight:600">${S.flyerPreview?'åˆ¥ã®å†™çœŸã«å¤‰æ›´':'ãƒãƒ©ã‚·ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰'}</div>
        <div style="font-size:12px;color:#aaa;margin-top:3px">ã‚¿ãƒƒãƒ—ã—ã¦æ’®å½± or ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ</div>
      </div>
      <input type="file" id="fly-inp" accept="image/*" style="display:none" onchange="handleFlyer(this)">
      ${rH}`;
  }
  else if(t==='memo'){
    body=`<div style="font-size:13px;color:#888;margin-bottom:9px">âœï¸ ä»Šæ—¥ã®è²·ã„ç‰©ãƒ¡ãƒ¢</div>
      <textarea class="ma" oninput="S.memo=this.value;save()" placeholder="ä¾‹ï¼š&#10;ãƒ»ç‰›ä¹³ Ã— 2æœ¬&#10;ãƒ»åµ&#10;&#10;â€» è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™">${esc(S.memo)}</textarea>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="bg" style="flex:1" onclick="S.memo='';save();R()">ğŸ—‘ ã‚¯ãƒªã‚¢</button>
        <button class="bp" style="flex:2" onclick="memoToList()">ğŸ“‹ ãƒªã‚¹ãƒˆã«å¤‰æ›</button>
      </div><div style="font-size:11px;color:#bbb;margin-top:7px;text-align:center">è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™</div>`;
  }
  return `<div class="fade">
    <div class="stabs">
      <button class="stb ${t==='list'?'sa':''}"    onclick="setST('list')">ğŸ“‹ ãƒªã‚¹ãƒˆ</button>
      <button class="stb ${t==='receipt'?'sa':''}" onclick="setST('receipt')">ğŸ§¾ ãƒ¬ã‚·ãƒ¼ãƒˆ</button>
      <button class="stb ${t==='flyer'?'sa':''}"   onclick="setST('flyer')">ğŸ“¸ ãƒãƒ©ã‚·</button>
      <button class="stb ${t==='memo'?'sa':''}"    onclick="setST('memo')">âœï¸ ãƒ¡ãƒ¢</button>
    </div>${body}</div>`;
}

function rAddShopMo(){
  return `<div class="ov" onclick="closeAddShop()"><div class="mo" style="max-width:340px;margin:0 auto" onclick="event.stopPropagation()">
    <div class="mt">ãƒªã‚¹ãƒˆã«è¿½åŠ </div>
    <div class="field"><label class="lbl">å“å</label>
      <input class="fi3" placeholder="ä¾‹: åµ" value="${esc(S.shopForm.name)}" oninput="S.shopForm.name=this.value"></div>
    <div class="field"><label class="lbl">æ•°é‡ï¼ˆä»»æ„ï¼‰</label>
      <input class="fi3" placeholder="ä¾‹: 1ãƒ‘ãƒƒã‚¯" value="${esc(S.shopForm.qty)}" oninput="S.shopForm.qty=this.value"></div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button class="bg" style="flex:1" onclick="closeAddShop()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="bp" style="flex:2" onclick="addShopItem()">è¿½åŠ </button>
    </div></div></div>`;
}

function rMeals(){
  const urg=S.items.filter(i=>dl(i.expiry)<=3);
  const pH=S.mealLoading?`<div class="lb"><div class="sp"></div><p>çŒ®ç«‹ã‚’ç”Ÿæˆä¸­...</p></div>`
    :S.mealPlan&&!S.mealPlan.error?`<div>
      ${(S.mealPlan.days||[]).map(day=>`<div class="dc">
        <div style="font-size:13px;font-weight:700;color:#555;margin-bottom:10px;padding-bottom:7px;border-bottom:1px solid #f0ede8">${esc(day.day)}</div>
        ${(day.meals||[]).map(m=>`<div class="mr">
          <div style="font-size:10px;font-weight:700;color:#aaa;width:32px;padding-top:2px;flex-shrink:0">${esc(m.type)}</div>
          <div style="flex:1">
            <div style="font-size:13px;font-weight:600;display:flex;align-items:center;gap:6px;flex-wrap:wrap">
              ${esc(m.name)}${m.urgent?`<span style="font-size:10px;background:#fff3e0;color:#e65100;padding:2px 6px;border-radius:20px">ğŸ”¥æœŸé™å„ªå…ˆ</span>`:''}
            </div>
            <div style="font-size:11px;color:#888;margin-top:2px">${(m.ingredients||[]).map(esc).join('ãƒ»')}</div>
            <div style="font-size:10px;color:#aaa">â± ${esc(m.time)}</div>
          </div></div>`).join('')}</div>`).join('')}
      ${S.mealPlan.tips?`<div style="background:#f0fdf4;border:1px solid #a5d6a7;border-radius:11px;padding:13px"><b>ğŸ’¡ ã‚¢ãƒ‰ãƒã‚¤ã‚¹</b><p style="margin-top:5px;font-size:13px;line-height:1.6">${esc(S.mealPlan.tips)}</p></div>`:''}
    </div>`:S.mealPlan?.error?`<div class="err">çŒ®ç«‹ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚</div>`
    :`<div class="empty"><div style="font-size:42px;margin-bottom:10px">ğŸ½ï¸</div>ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦AIã«<br>çŒ®ç«‹ã‚’ææ¡ˆã—ã¦ã‚‚ã‚‰ã„ã¾ã—ã‚‡ã†</div>`;
  return `<div class="fade">
    <button class="bp" style="width:100%;padding:13px;font-size:15px;margin-bottom:7px" onclick="genMeals()" ${S.mealLoading?'disabled':''}>
      ${S.mealLoading?'â³ è€ƒãˆã¦ã„ã¾ã™...':'ğŸ¤– AIã§3æ—¥é–“ã®çŒ®ç«‹ã‚’ç”Ÿæˆ'}
    </button>
    <p style="font-size:12px;color:#aaa;text-align:center;margin-bottom:13px">æœŸé™é–“è¿‘ã®é£Ÿæã‚’å„ªå…ˆã—ã¦ææ¡ˆã—ã¾ã™</p>
    ${urg.length>0?`<div style="background:#fff3e0;border-radius:11px;padding:11px;font-size:13px;margin-bottom:13px;line-height:1.7"><b>âš ï¸ æœŸé™é–“è¿‘ï¼š</b>${urg.map(i=>`${i.name}ï¼ˆ${el(dl(i.expiry))}ï¼‰`).join('ã€€')}</div>`:''}
    ${pH}</div>`;
}

// â•â•â•â•â•â• ACTIONS â•â•â•â•â•â•
function switchTab(t){S.tab=t;R()}
function setFridge(id){S.fridge=id;S.tab='items';R()}
function setQ(v){S.q=v;R()}

// â”€ Itemsï¼ˆconfirm()å»ƒæ­¢ â†’ ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ç¢ºèªï¼‰
function chQty(id,d){
  const i=S.items.find(x=>x.id===id);if(!i)return;
  const nq=Math.max(0,parseFloat((Number(i.qty)+d).toFixed(2)));
  if(nq===0){ S.pendingDelete=id; R(); return; }
  i.qty=nq; save(); R();
}
function delItem(id){ S.pendingDelete=id; R(); }
function confirmDelete(id){ S.items=S.items.filter(x=>x.id!==id); S.pendingDelete=null; save(); R(); }
function cancelDelete(){ S.pendingDelete=null; R(); }

// â”€ Add item modalï¼ˆâ˜… å†·è”µåº«ãƒã‚°ä¿®æ­£ï¼šsetFF/setFCã¯S.formã‚’æ›´æ–°ã—ã¦R()ã™ã‚‹ï¼‰
function openAdd(){S.addOpen=true;R();setTimeout(()=>document.querySelector('.mo')?.scrollTo(0,0),50)}
function closeAdd(){S.addOpen=false;R()}
function setFC(c){S.form={...S.form,category:c,name:"",unit:"å€‹",qty:1};R()}
function setFF(id){S.form.fridgeId=id;R()}   // â˜… ã“ã“ãŒãƒã‚°ã®æ ¸å¿ƒï¼šidã‚’æ•°å€¤ã§ä¿å­˜ã—ã¦R()
function selP(n,u,q,e){S.form={...S.form,name:n,unit:u,qty:q,expiry:dfn(e)};R()}
function addItem(){
  const f=S.form;if(!f.name.trim())return;
  S.items.push({id:uid(),name:f.name.trim(),fridgeId:Number(f.fridgeId),category:f.category,qty:Number(f.qty)||1,unit:f.unit,expiry:f.expiry,note:f.note});
  S.freq[f.name.trim()]=(S.freq[f.name.trim()]||0)+1;
  S.form={name:"",fridgeId:1,category:"dairy",qty:1,unit:"å€‹",expiry:dfn(7),note:""};
  S.addOpen=false;save();R();
}

// â”€ Shopping
function setST(t){S.shopTab=t;R()}
function openAddShop(){S.addShopOpen=true;R()}
function closeAddShop(){S.addShopOpen=false;R()}
function addShopItem(){if(!S.shopForm.name.trim())return;S.shopping.push({id:uid(),name:S.shopForm.name.trim(),qty:S.shopForm.qty,done:false});S.shopForm={name:"",qty:""};S.addShopOpen=false;save();R()}
function addSugg(n){if(!S.shopping.find(s=>s.name===n))S.shopping.push({id:uid(),name:n,qty:"",done:false});save();R()}
function addFS(n){addSugg(n);S.shopTab='list';R()}
function togShop(id){S.shopping=S.shopping.map(s=>s.id===id?{...s,done:!s.done}:s);save();R()}
function delShop(id){S.shopping=S.shopping.filter(s=>s.id!==id);save();R()}
function clearDone(){S.shopping=S.shopping.filter(s=>!s.done);save();R()}
function memoToList(){
  S.memo.split('\n').map(l=>l.replace(/^[ãƒ»\-\*\s]+/,'').trim()).filter(Boolean)
    .forEach(l=>{if(!S.shopping.find(s=>s.name===l))S.shopping.push({id:uid(),name:l,qty:"",done:false})});
  S.shopTab='list';save();R();
}

// â”€ Receipt
function handleReceipt(inp){
  const file=inp.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=async(ev)=>{
    S.receiptPreview=ev.target.result;S.receiptLoading=true;S.receiptResult=null;S.receiptConfirm=null;R();
    try{
      const b64=ev.target.result.split(',')[1],mime=file.type||'image/jpeg';
      const res=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:1000,messages:[{role:'user',content:[
          {type:'image',source:{type:'base64',media_type:mime,data:b64}},
          {type:'text',text:`ã“ã®ãƒ¬ã‚·ãƒ¼ãƒˆã‹ã‚‰è³¼å…¥ã—ãŸé£Ÿæãƒ»é£Ÿå“ã®ã¿èª­ã¿å–ã£ã¦ãã ã•ã„ï¼ˆæ—¥ç”¨å“ãƒ»é›‘è²¨ã¯é™¤ãï¼‰ã€‚
å†·è”µåº«3å°ã®æŒ¯ã‚Šåˆ†ã‘ã‚¬ã‚¤ãƒ‰ï¼šå†·è”µåº«A(fridgeId:1 = è‚‰ãƒ»ä¹³è£½å“ãƒ»é£²æ–™)ã€å†·è”µåº«B(fridgeId:2 = é‡èœãƒ»æœç‰©)ã€å†·è”µåº«C(fridgeId:3 = å†·å‡ãƒ»èª¿å‘³æ–™)ã€‚
ä»Šæ—¥ã®æ—¥ä»˜: ${new Date().toISOString().split('T')[0]}
JSONã®ã¿ã§å›ç­”ï¼š{"items":[{"name":"é£Ÿæå","qty":1,"unit":"å€‹","category":"dairy/meat/vegetable/frozen/seasoning/drink/other","fridgeId":1,"expiry":"YYYY-MM-DD","confidence":"high/low"}]}`}
        ]}]})
      });
      const d=await res.json();
      const parsed=JSON.parse(d.content?.map(b=>b.text||'').join('').replace(/```json|```/g,'').trim());
      S.receiptConfirm=(parsed.items||[]).map(i=>({...i,fridgeId:Number(i.fridgeId)||1,selected:i.confidence!=='low'}));
      S.receiptResult=parsed;
    }catch(e){S.receiptResult={error:true}}
    S.receiptLoading=false;R();
  };
  reader.readAsDataURL(file);
}
function togRC(i){S.receiptConfirm[i].selected=!S.receiptConfirm[i].selected;R()}
function edRC(i){
  const c=prompt('å†·è”µåº«ã‚’ç•ªå·ã§å…¥åŠ›:\n1 = å†·è”µåº«Aï¼ˆè‚‰ãƒ»ä¹³è£½å“ï¼‰\n2 = å†·è”µåº«Bï¼ˆé‡èœï¼‰\n3 = å†·è”µåº«Cï¼ˆå†·å‡ãƒ»èª¿å‘³æ–™ï¼‰');
  const n=parseInt(c);if(n>=1&&n<=3){S.receiptConfirm[i].fridgeId=n;R();}
}
function bulkAdd(){
  const sel=S.receiptConfirm.filter(i=>i.selected);
  sel.forEach(i=>{S.items.push({id:uid(),name:i.name,fridgeId:Number(i.fridgeId)||1,category:i.category||'other',qty:parseFloat(i.qty)||1,unit:i.unit||'å€‹',expiry:i.expiry||dfn(7),note:'ğŸ§¾ ãƒ¬ã‚·ãƒ¼ãƒˆã‹ã‚‰è¿½åŠ '});S.freq[i.name]=(S.freq[i.name]||0)+1;});
  S.receiptConfirm=null;S.receiptPreview=null;S.receiptResult=null;
  save();switchTab('items');alert(`âœ… ${sel.length}ä»¶ã®é£Ÿæã‚’åœ¨åº«ã«è¿½åŠ ã—ã¾ã—ãŸï¼`);
}

// â”€ Flyer
function handleFlyer(inp){
  const file=inp.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=async(ev)=>{
    S.flyerPreview=ev.target.result;S.flyerLoading=true;S.flyerResult=null;R();
    try{
      const b64=ev.target.result.split(',')[1],mime=file.type||'image/jpeg';
      const stock=S.items.map(i=>i.name).join('ã€');
      const res=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:900,messages:[{role:'user',content:[
          {type:'image',source:{type:'base64',media_type:mime,data:b64}},
          {type:'text',text:`ãƒãƒ©ã‚·ã‚’åˆ†æã€‚åœ¨åº«:${stock||'ãªã—'}\nJSONã®ã¿ï¼š{"items":[{"name":"å•†å“å","price":"Â¥000","originalPrice":"Â¥000","discount":"30%OFF","recommend":true,"reason":"ç†ç”±"}],"summary":"æ¦‚è¦","bestDeal":"æœ€ã‚‚ãŠå¾—"}`}
        ]}]})
      });
      const d=await res.json();
      S.flyerResult=JSON.parse(d.content?.map(b=>b.text||'').join('').replace(/```json|```/g,'').trim());
    }catch(e){S.flyerResult={error:true}}
    S.flyerLoading=false;R();
  };
  reader.readAsDataURL(file);
}

// â”€ AI
async function getShopSugg(){
  S.shopLoading=true;S.shopSugg=null;R();
  try{const s=S.items.map(i=>`${i.name} ${i.qty}${i.unit}`).join('ã€');
    const res=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:600,messages:[{role:'user',content:`åœ¨åº«ï¼š${s||'ãªã—'}\nä¸è¶³é£Ÿæã‚’ææ¡ˆã€‚JSONï¼š{"items":[{"name":"åå‰","reason":"ç†ç”±","priority":"é«˜/ä¸­/ä½"}]}`}]})
    });const d=await res.json();
    S.shopSugg=JSON.parse(d.content?.map(b=>b.text||'').join('').replace(/```json|```/g,'').trim());
  }catch(e){S.shopSugg={error:true}}
  S.shopLoading=false;R();
}
async function genMeals(){
  S.mealLoading=true;S.mealPlan=null;R();
  try{const urg=S.items.filter(i=>dl(i.expiry)<=3);
    const u=urg.map(i=>`${i.name}ï¼ˆ${el(dl(i.expiry))}ï¼‰`).join('ã€'),a=S.items.map(i=>i.name).join('ã€');
    const res=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:1000,messages:[{role:'user',content:`æ–™ç†å°‚é–€å®¶ã¨ã—ã¦çŒ®ç«‹ã‚’ææ¡ˆã€‚\næœŸé™é–“è¿‘:${u||'ãªã—'}\nå…¨åœ¨åº«:${a}\n3æ—¥åˆ†æœæ˜¼å¤•ã‚’JSONï¼š{"days":[{"day":"ä»Šæ—¥","meals":[{"type":"æœé£Ÿ","name":"æ–™ç†å","ingredients":["é£Ÿæ"],"time":"15åˆ†","urgent":true},...]},...], "tips":"ã‚¢ãƒ‰ãƒã‚¤ã‚¹"}`}]})
    });const d=await res.json();
    S.mealPlan=JSON.parse(d.content?.map(b=>b.text||'').join('').replace(/```json|```/g,'').trim());
  }catch(e){S.mealPlan={error:true}}
  S.mealLoading=false;R();
}

function showHelp(){document.getElementById('hov').style.display='block'}
function hideHelp(){document.getElementById('hov').style.display='none'}

// â•â•â•â•â•â• INIT â•â•â•â•â•â•
loadSaved();R();
</script>
</body>
</html>
