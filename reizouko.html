<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>ğŸ  ãŠã†ã¡å†·è”µåº«</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
/* â”€â”€ Reset & Base â”€â”€ */
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{font-family:'Noto Sans JP','Hiragino Kaku Gothic ProN',sans-serif;background:#f4f1ec;color:#1a1a1a;min-height:100vh}
input,select,textarea,button{font-family:inherit}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-thumb{background:#d0c9b8;border-radius:2px}

/* â”€â”€ App shell â”€â”€ */
#app{max-width:520px;margin:0 auto;min-height:100vh;position:relative}

/* â”€â”€ Header â”€â”€ */
.header{background:#1a1a1a;color:#fff;position:sticky;top:0;z-index:100}
.h-top{display:flex;align-items:center;justify-content:space-between;padding:14px 16px 8px}
.logo{font-size:18px;font-weight:700}
.logo-sub{font-size:10px;color:#888;letter-spacing:.1em}
.alert-badge{background:#e53935;color:#fff;font-size:12px;font-weight:600;padding:6px 12px;border-radius:20px;cursor:pointer;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
nav{display:flex;border-top:1px solid #333}
.nav-btn{flex:1;background:transparent;border:none;color:#888;cursor:pointer;padding:10px 4px;font-size:11px;display:flex;flex-direction:column;align-items:center;gap:2px;transition:all .2s;letter-spacing:.03em}
.nav-btn.active{color:#fff;background:#333}
.nav-icon{font-size:18px}

/* â”€â”€ Main â”€â”€ */
main{padding:16px 14px 100px}
.fade{animation:fi .3s ease}
@keyframes fi{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* â”€â”€ Cards & common â”€â”€ */
.card{background:#fff;border-radius:14px;box-shadow:0 1px 6px rgba(0,0,0,.06)}
.sec-title{font-size:13px;font-weight:700;color:#555;letter-spacing:.05em;margin:16px 0 10px}
.empty{text-align:center;padding:40px 20px;color:#bbb;font-size:14px}

/* â”€â”€ Stats row â”€â”€ */
.stats-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:20px}
.stat-card{padding:14px 10px;text-align:center;cursor:pointer}
.stat-n{font-size:26px;font-weight:700}
.stat-l{font-size:11px;color:#aaa;margin-top:2px}

/* â”€â”€ Fridge grid â”€â”€ */
.fridge-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.fridge-card{padding:14px 10px;text-align:center;cursor:pointer;border:2px solid;transition:transform .2s}
.fridge-card:active{transform:scale(.97)}
.fridge-ico{width:40px;height:40px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px;margin:0 auto 8px}
.fridge-name{font-size:12px;font-weight:600}
.fridge-cnt{font-size:20px;font-weight:700;margin-top:4px}
.fridge-warn{font-size:10px;color:#e53935;margin-top:4px}

/* â”€â”€ Urgent row â”€â”€ */
.urg-row{display:flex;align-items:center;gap:12px;background:#fff;border-radius:12px;padding:12px 14px;margin-bottom:8px;box-shadow:0 1px 6px rgba(0,0,0,.06);border-left:3px solid #e53935}

/* â”€â”€ Expiry badge â”€â”€ */
.exp-badge{font-size:12px;font-weight:600;padding:3px 9px;border-radius:20px;flex-shrink:0}

/* â”€â”€ Filter row â”€â”€ */
.filter-row{display:flex;gap:8px;overflow-x:auto;padding-bottom:4px;margin-bottom:12px;-ms-overflow-style:none;scrollbar-width:none}
.filter-row::-webkit-scrollbar{display:none}
.fbtn{padding:7px 14px;border-radius:20px;border:1.5px solid #e0dbd2;background:#fff;font-size:12px;cursor:pointer;white-space:nowrap;transition:all .2s}
.fbtn.factive{background:#1a1a1a;border-color:#1a1a1a;color:#fff}

/* â”€â”€ Search â”€â”€ */
.sinput{width:100%;padding:10px 14px;border:1.5px solid #e8e4dc;border-radius:12px;font-size:14px;background:#fff;margin-bottom:12px;outline:none}
.sinput:focus{border-color:#aaa}

/* â”€â”€ Item row â”€â”€ */
.irow{display:flex;align-items:center;gap:12px;background:#fff;border-radius:12px;padding:12px 14px;box-shadow:0 1px 4px rgba(0,0,0,.05);transition:transform .15s}
.irow:active{transform:scale(.99)}
.item-list{display:flex;flex-direction:column;gap:8px}
.item-name{font-size:14px;font-weight:600}
.item-meta{font-size:12px;color:#888;display:flex;gap:4px;flex-wrap:wrap;margin-top:2px}

/* â”€â”€ Buttons â”€â”€ */
.btn-primary{background:#1a1a1a;color:#fff;border:none;border-radius:12px;padding:12px 20px;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;justify-content:center;gap:6px}
.btn-primary:active{background:#333;transform:translateY(1px)}
.btn-primary:disabled{opacity:.5;cursor:not-allowed}
.btn-ghost{background:#f5f2ed;color:#555;border:none;border-radius:12px;padding:10px 16px;font-size:14px;cursor:pointer;transition:all .2s}
.btn-ghost:active{background:#ede9e2}
.xbtn{background:none;border:none;color:#ddd;font-size:22px;cursor:pointer;padding:4px;flex-shrink:0;line-height:1}
.xbtn:active{color:#e57373}

/* â”€â”€ FAB â”€â”€ */
.fab{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:#1a1a1a;color:#fff;border:none;border-radius:28px;padding:14px 28px;font-size:15px;font-weight:600;cursor:pointer;box-shadow:0 4px 20px rgba(0,0,0,.3);z-index:50;transition:all .2s;white-space:nowrap}
.fab:active{background:#333;transform:translateX(-50%) translateY(2px)}

/* â”€â”€ Modal / Overlay â”€â”€ */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;display:flex;align-items:flex-end;justify-content:center}
.modal{background:#fff;border-radius:20px 20px 0 0;padding:24px 20px;width:100%;max-width:520px;max-height:88vh;overflow-y:auto}
.m-title{font-size:18px;font-weight:700;margin-bottom:18px}
.field{margin-bottom:14px}
.lbl{font-size:12px;color:#888;font-weight:600;display:block;margin-bottom:6px}
.fi{width:100%;padding:10px 14px;border:1.5px solid #e8e4dc;border-radius:10px;font-size:14px;background:#fafaf8;outline:none;transition:border .2s}
.fi:focus{border-color:#aaa;background:#fff}

/* â”€â”€ Preset chips â”€â”€ */
.preset-wrap{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:14px}
.preset-chip{padding:8px 12px;border-radius:12px;border:1.5px solid #e0dbd2;background:#fff;color:#333;cursor:pointer;font-size:13px;transition:all .2s;display:flex;align-items:center;gap:4px}
.preset-chip.selected{background:#1a1a1a;border-color:#1a1a1a;color:#fff}
.preset-chip.hot{background:#fff8e1}
.preset-chip.used{background:#f9f9f9}

/* â”€â”€ Sub-tabs â”€â”€ */
.subtabs{display:flex;gap:4px;margin-bottom:16px;background:#ede9e2;border-radius:12px;padding:4px}
.stab{flex:1;padding:8px 4px;border:none;background:transparent;font-size:12px;cursor:pointer;border-radius:8px;transition:all .2s;color:#888}
.stab.stactive{background:#fff;color:#1a1a1a;font-weight:700;box-shadow:0 1px 4px rgba(0,0,0,.1)}

/* â”€â”€ Shopping â”€â”€ */
.sugg-box{background:#fff;border-radius:14px;padding:16px;margin-bottom:16px;box-shadow:0 1px 6px rgba(0,0,0,.06)}
.p-badge{font-size:11px;font-weight:600;padding:2px 8px;border-radius:20px;margin-left:6px}

/* â”€â”€ Flyer â”€â”€ */
.flyer-upload{background:#fff;border-radius:16px;padding:32px;text-align:center;cursor:pointer;border:2px dashed #ddd;margin-bottom:16px;display:flex;flex-direction:column;align-items:center;transition:border .2s}
.flyer-upload:active{border-color:#aaa}
.flyer-item{background:#fff;border-radius:12px;padding:12px 14px;display:flex;align-items:flex-start;gap:12px;box-shadow:0 1px 4px rgba(0,0,0,.05);margin-bottom:8px}

/* â”€â”€ Memo â”€â”€ */
.memo-area{width:100%;min-height:220px;padding:14px;border:1.5px solid #e8e4dc;border-radius:14px;font-size:15px;line-height:1.9;background:#fff;outline:none;resize:vertical}

/* â”€â”€ Meals â”€â”€ */
.day-card{background:#fff;border-radius:14px;padding:16px;margin-bottom:12px;box-shadow:0 1px 6px rgba(0,0,0,.06)}
.meal-row{display:flex;gap:12px;padding:8px 0;border-bottom:1px solid #fafaf8;align-items:flex-start}

/* â”€â”€ Loading â”€â”€ */
.load-box{text-align:center;padding:40px 20px;color:#aaa}
.spin{width:36px;height:36px;border:3px solid #eee;border-top-color:#1a1a1a;border-radius:50%;animation:sp 1s linear infinite;margin:0 auto 12px}
@keyframes sp{to{transform:rotate(360deg)}}
.err-box{background:#fce4ec;border-radius:12px;padding:14px;color:#c62828;font-size:13px}

/* â”€â”€ Help overlay â”€â”€ */
.help-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:300;overflow-y:auto;padding:20px 16px 40px}
.help-box{background:#fff;border-radius:20px;padding:24px 20px;max-width:480px;margin:0 auto}
.help-step{display:flex;gap:14px;align-items:flex-start;margin-bottom:20px}
.help-num{width:32px;height:32px;background:#1a1a1a;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;flex-shrink:0}
</style>
</head>
<body>
<div id="app">
  <!-- Header -->
  <div class="header">
    <div class="h-top">
      <div>
        <div class="logo">ğŸ  ãŠã†ã¡å†·è”µåº«</div>
        <div class="logo-sub">FAMILY FRIDGE MANAGER</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div id="alert-badge" class="alert-badge" style="display:none" onclick="switchTab('items')"></div>
        <button class="btn-ghost" style="padding:6px 12px;font-size:12px" onclick="showHelp()">â“ ä½¿ã„æ–¹</button>
      </div>
    </div>
    <nav>
      <button class="nav-btn active" id="nav-home" onclick="switchTab('home')"><span class="nav-icon">ğŸ </span><span>ãƒ›ãƒ¼ãƒ </span></button>
      <button class="nav-btn" id="nav-items" onclick="switchTab('items')"><span class="nav-icon">ğŸ§Š</span><span>åœ¨åº«</span></button>
      <button class="nav-btn" id="nav-shopping" onclick="switchTab('shopping')"><span class="nav-icon">ğŸ›’</span><span>è²·ã„ç‰©</span></button>
      <button class="nav-btn" id="nav-meals" onclick="switchTab('meals')"><span class="nav-icon">ğŸ³</span><span>çŒ®ç«‹</span></button>
    </nav>
  </div>

  <main id="main-content"></main>
</div>

<!-- Help Modal -->
<div id="help-overlay" class="help-overlay" style="display:none" onclick="hideHelp()">
  <div class="help-box" onclick="event.stopPropagation()">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <div style="font-size:20px;font-weight:700">ğŸ“– ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</div>
      <button class="xbtn" onclick="hideHelp()" style="font-size:26px">Ã—</button>
    </div>

    <div class="help-step">
      <div class="help-num">1</div>
      <div>
        <div style="font-weight:700;margin-bottom:4px">ğŸ§Š é£Ÿæã‚’ç™»éŒ²ã™ã‚‹</div>
        <div style="font-size:13px;color:#555;line-height:1.7">ã€Œåœ¨åº«ã€ã‚¿ãƒ–ã‚’é–‹ã„ã¦ç”»é¢ä¸‹ã®<b>ã€Œï¼‹ é£Ÿæã‚’è¿½åŠ ã€</b>ã‚’ã‚¿ãƒƒãƒ—ã€‚ã‚«ãƒ†ã‚´ãƒªã‚’é¸ã¶ã¨é£Ÿæä¸€è¦§ãŒå‡ºã‚‹ã®ã§ã€ã‚¿ãƒƒãƒ—ã™ã‚‹ã ã‘ã§ç™»éŒ²ã§ãã¾ã™ã€‚æ¶ˆè²»æœŸé™ã¯è‡ªå‹•å…¥åŠ›ã•ã‚Œã‚‹ã®ã§ç¢ºèªã™ã‚‹ã ã‘ã§OKï¼</div>
      </div>
    </div>

    <div class="help-step">
      <div class="help-num">2</div>
      <div>
        <div style="font-weight:700;margin-bottom:4px">ğŸ  ãƒ›ãƒ¼ãƒ ã§çŠ¶æ³ç¢ºèª</div>
        <div style="font-size:13px;color:#555;line-height:1.7">ã€Œãƒ›ãƒ¼ãƒ ã€ã‚¿ãƒ–ã§ã¯3å°ã®å†·è”µåº«ã®çŠ¶æ³ã¨ã€<b>ä»Šã™ãä½¿ã†ã¹ãé£Ÿæ</b>ï¼ˆæœŸé™é–“è¿‘ï¼‰ãŒä¸€ç›®ã§ã‚ã‹ã‚Šã¾ã™ã€‚âš ï¸ãƒãƒ¼ã‚¯ã¯æœŸé™2æ—¥ä»¥å†…ã®ã‚µã‚¤ãƒ³ã§ã™ï¼</div>
      </div>
    </div>

    <div class="help-step">
      <div class="help-num">3</div>
      <div>
        <div style="font-weight:700;margin-bottom:4px">ğŸ›’ è²·ã„ç‰©ãƒªã‚¹ãƒˆã‚’ä½¿ã†</div>
        <div style="font-size:13px;color:#555;line-height:1.7">ã€Œè²·ã„ç‰©ã€ã‚¿ãƒ–ã«3ã¤ã®æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã™ï¼š<br>
        ãƒ»<b>ãƒªã‚¹ãƒˆ</b>ï¼šè²·ã†ã‚‚ã®ã‚’ã¾ã¨ã‚ã‚‹<br>
        ãƒ»<b>ãƒãƒ©ã‚·èª­å–</b>ï¼šå†™çœŸã‚’æ’®ã‚‹ã¨AIãŒå®‰ã„å•†å“ã‚’æ•™ãˆã¦ãã‚Œã‚‹<br>
        ãƒ»<b>ãƒ¡ãƒ¢</b>ï¼šè‡ªç”±æ›¸ãâ†’ãƒªã‚¹ãƒˆã«å¤‰æ›ã§ãã‚‹</div>
      </div>
    </div>

    <div class="help-step">
      <div class="help-num">4</div>
      <div>
        <div style="font-weight:700;margin-bottom:4px">ğŸ³ çŒ®ç«‹ã‚’ä½œã£ã¦ã‚‚ã‚‰ã†</div>
        <div style="font-size:13px;color:#555;line-height:1.7">ã€ŒçŒ®ç«‹ã€ã‚¿ãƒ–ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€<b>æœŸé™ã®è¿‘ã„é£Ÿæã‚’å„ªå…ˆ</b>ã—ãŸ3æ—¥åˆ†ã®çŒ®ç«‹ã‚’AIãŒææ¡ˆã—ã¾ã™ã€‚é£Ÿæãƒ­ã‚¹ã‚¼ãƒ­ã‚’ç›®æŒ‡ã›ã¾ã™ï¼</div>
      </div>
    </div>

    <div style="background:#f0fdf4;border-radius:12px;padding:14px;font-size:13px;line-height:1.7">
      ğŸ’¡ <b>ãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•ä¿å­˜</b>ã•ã‚Œã¾ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ã¦ã‚‚æ¶ˆãˆã¾ã›ã‚“ã€‚<br>
      å®¶æ—ã¸ã®å…±æœ‰ã¯ã€ã“ã®ãƒšãƒ¼ã‚¸ã®URLã‚’LINEã§é€ã‚‹ã ã‘ï¼
    </div>

    <button class="btn-primary" style="width:100%;margin-top:20px" onclick="hideHelp()">ã¨ã˜ã‚‹</button>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FRIDGES = [
  {id:1, name:"å†·è”µåº« A", icon:"ğŸ§Š", color:"#4fc3f7", dark:"#0288d1"},
  {id:2, name:"å†·è”µåº« B", icon:"â„ï¸",  color:"#81c784", dark:"#388e3c"},
  {id:3, name:"å†·è”µåº« C", icon:"ğŸ«™",  color:"#ffb74d", dark:"#f57c00"},
];
const CATEGORIES = [
  {id:"vegetable", label:"é‡èœãƒ»æœç‰©", icon:"ğŸ¥¦"},
  {id:"meat",      label:"è‚‰ãƒ»é­š",    icon:"ğŸ¥©"},
  {id:"dairy",     label:"ä¹³è£½å“",    icon:"ğŸ¥›"},
  {id:"drink",     label:"é£²ã¿ç‰©",    icon:"ğŸ§ƒ"},
  {id:"seasoning", label:"èª¿å‘³æ–™",    icon:"ğŸ§‚"},
  {id:"frozen",    label:"å†·å‡é£Ÿå“",  icon:"ğŸ§Š"},
  {id:"leftovers", label:"ä½œã‚Šç½®ã",  icon:"ğŸ±"},
  {id:"other",     label:"ãã®ä»–",    icon:"ğŸ“¦"},
];
const UNITS = ["å€‹","æœ¬","è¢‹","ãƒ‘ãƒƒã‚¯","g","kg","ml","L","æš","æŸ","åˆ‡ã‚Œ","äººåˆ†"];
const PRESETS = {
  dairy:[
    {name:"ç‰›ä¹³",unit:"L",qty:1,exp:7},{name:"åµ",unit:"å€‹",qty:6,exp:14},
    {name:"ãƒ¨ãƒ¼ã‚°ãƒ«ãƒˆ",unit:"å€‹",qty:2,exp:10},{name:"ãƒãƒ¼ã‚º",unit:"è¢‹",qty:1,exp:21},
    {name:"ãƒã‚¿ãƒ¼",unit:"å€‹",qty:1,exp:30},{name:"ç”Ÿã‚¯ãƒªãƒ¼ãƒ ",unit:"ãƒ‘ãƒƒã‚¯",qty:1,exp:5},
    {name:"è±†ä¹³",unit:"æœ¬",qty:1,exp:7},{name:"ãƒ—ãƒªãƒ³",unit:"å€‹",qty:3,exp:7},
  ],
  vegetable:[
    {name:"ã‚­ãƒ£ãƒ™ãƒ„",unit:"å€‹",qty:1,exp:7},{name:"ã«ã‚“ã˜ã‚“",unit:"æœ¬",qty:3,exp:14},
    {name:"ã»ã†ã‚Œã‚“è‰",unit:"è¢‹",qty:1,exp:4},{name:"ã‚‚ã‚„ã—",unit:"è¢‹",qty:1,exp:2},
    {name:"ç‰ã­ã",unit:"å€‹",qty:3,exp:14},{name:"ãƒˆãƒãƒˆ",unit:"å€‹",qty:3,exp:5},
    {name:"ãã‚…ã†ã‚Š",unit:"æœ¬",qty:3,exp:5},{name:"ãƒ¬ã‚¿ã‚¹",unit:"å€‹",qty:1,exp:5},
    {name:"ãƒ–ãƒ­ãƒƒã‚³ãƒªãƒ¼",unit:"å€‹",qty:1,exp:5},{name:"ã˜ã‚ƒãŒã„ã‚‚",unit:"å€‹",qty:3,exp:14},
    {name:"ã‚Šã‚“ã”",unit:"å€‹",qty:3,exp:14},{name:"ãƒãƒŠãƒŠ",unit:"æœ¬",qty:5,exp:5},
  ],
  meat:[
    {name:"é¶ã‚€ã­è‚‰",unit:"g",qty:300,exp:3},{name:"é¶ã‚‚ã‚‚è‚‰",unit:"g",qty:300,exp:3},
    {name:"è±šãƒãƒ©è‚‰",unit:"g",qty:200,exp:3},{name:"è±šã“ã¾è‚‰",unit:"ãƒ‘ãƒƒã‚¯",qty:1,exp:3},
    {name:"ç‰›è‚‰",unit:"g",qty:200,exp:3},{name:"ã²ãè‚‰",unit:"g",qty:200,exp:2},
    {name:"é®­",unit:"åˆ‡ã‚Œ",qty:2,exp:2},{name:"ã•ã°",unit:"åˆ‡ã‚Œ",qty:2,exp:2},
    {name:"ãˆã³",unit:"g",qty:150,exp:2},{name:"ã‚¦ã‚¤ãƒ³ãƒŠãƒ¼",unit:"è¢‹",qty:1,exp:14},
    {name:"ãƒ™ãƒ¼ã‚³ãƒ³",unit:"è¢‹",qty:1,exp:14},
  ],
  drink:[
    {name:"éº¦èŒ¶",unit:"L",qty:2,exp:3},{name:"ã‚ªãƒ¬ãƒ³ã‚¸ã‚¸ãƒ¥ãƒ¼ã‚¹",unit:"L",qty:1,exp:7},
    {name:"ç‚­é…¸æ°´",unit:"æœ¬",qty:6,exp:30},{name:"ã‚¹ãƒãƒ¼ãƒ„ãƒ‰ãƒªãƒ³ã‚¯",unit:"æœ¬",qty:2,exp:30},
    {name:"ã‚³ãƒ¼ãƒ’ãƒ¼(ç´™ãƒ‘ãƒƒã‚¯)",unit:"æœ¬",qty:2,exp:30},
  ],
  seasoning:[
    {name:"é†¤æ²¹",unit:"æœ¬",qty:1,exp:90},{name:"ã¿ã‚Šã‚“",unit:"æœ¬",qty:1,exp:90},
    {name:"ãƒãƒ¨ãƒãƒ¼ã‚º",unit:"æœ¬",qty:1,exp:60},{name:"ã‚±ãƒãƒ£ãƒƒãƒ—",unit:"æœ¬",qty:1,exp:60},
    {name:"å‘³å™Œ",unit:"è¢‹",qty:1,exp:60},{name:"ãƒãƒ³é…¢",unit:"æœ¬",qty:1,exp:90},
    {name:"ãƒ‰ãƒ¬ãƒƒã‚·ãƒ³ã‚°",unit:"æœ¬",qty:1,exp:60},
  ],
  frozen:[
    {name:"å†·å‡ã†ã©ã‚“",unit:"å€‹",qty:3,exp:60},{name:"å†·å‡é¤ƒå­",unit:"è¢‹",qty:1,exp:60},
    {name:"å†·å‡æè±†",unit:"è¢‹",qty:1,exp:60},{name:"ã‚¢ã‚¤ã‚¹ã‚¯ãƒªãƒ¼ãƒ ",unit:"å€‹",qty:2,exp:30},
    {name:"å†·å‡ãƒãƒ£ãƒ¼ãƒãƒ³",unit:"è¢‹",qty:1,exp:60},{name:"å†·å‡ãƒ–ãƒ­ãƒƒã‚³ãƒªãƒ¼",unit:"è¢‹",qty:1,exp:60},
  ],
  leftovers:[
    {name:"ã‚«ãƒ¬ãƒ¼",unit:"äººåˆ†",qty:2,exp:2},{name:"ç…®ç‰©",unit:"äººåˆ†",qty:2,exp:3},
    {name:"ç‚’ã‚ç‰©",unit:"äººåˆ†",qty:2,exp:2},{name:"ã‚¹ãƒ¼ãƒ—",unit:"äººåˆ†",qty:2,exp:2},
    {name:"ã”é£¯",unit:"äººåˆ†",qty:3,exp:1},
  ],
  other:[
    {name:"è±†è…",unit:"å€‹",qty:2,exp:5},{name:"ã“ã‚“ã«ã‚ƒã",unit:"å€‹",qty:1,exp:14},
    {name:"ç´è±†",unit:"ãƒ‘ãƒƒã‚¯",qty:3,exp:7},{name:"é£Ÿãƒ‘ãƒ³",unit:"è¢‹",qty:1,exp:5},
    {name:"ã‚‚ãšã",unit:"å€‹",qty:3,exp:14},
  ],
};

function daysFromNow(d){const dt=new Date();dt.setDate(dt.getDate()+d);return dt.toISOString().split('T')[0]}
function daysLeft(s){const t=new Date();t.setHours(0,0,0,0);const e=new Date(s);e.setHours(0,0,0,0);return Math.round((e-t)/86400000)}
function expiryColor(d){if(d<0)return{bg:"#b71c1c",tx:"#fff"};if(d===0)return{bg:"#e53935",tx:"#fff"};if(d<=2)return{bg:"#ff6f00",tx:"#fff"};if(d<=5)return{bg:"#f9a825",tx:"#fff"};return{bg:"#e8f5e9",tx:"#2e7d32"}}
function expiryLabel(d){if(d<0)return`${Math.abs(d)}æ—¥è¶…éï¼`;if(d===0)return"ä»Šæ—¥ã¾ã§ï¼";if(d===1)return"æ˜æ—¥ã¾ã§";return`${d}æ—¥`}
function getCat(id){return CATEGORIES.find(c=>c.id===id)||CATEGORIES[7]}
function getFridge(id){return FRIDGES.find(f=>f.id===id)||FRIDGES[0]}
function todayStr(){return new Date().toISOString().split('T')[0]}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let state = {
  tab: 'home',
  items: [
    {id:1,name:"ç‰›ä¹³",fridgeId:1,category:"dairy",qty:1,unit:"L",expiry:daysFromNow(2),note:""},
    {id:2,name:"åµ",fridgeId:1,category:"dairy",qty:6,unit:"å€‹",expiry:daysFromNow(5),note:""},
    {id:3,name:"è±šè‚‰",fridgeId:1,category:"meat",qty:1,unit:"ãƒ‘ãƒƒã‚¯",expiry:daysFromNow(1),note:"ã—ã‚ƒã¶ã—ã‚ƒã¶ç”¨"},
    {id:4,name:"ã»ã†ã‚Œã‚“è‰",fridgeId:2,category:"vegetable",qty:1,unit:"è¢‹",expiry:daysFromNow(3),note:""},
    {id:5,name:"ã«ã‚“ã˜ã‚“",fridgeId:2,category:"vegetable",qty:3,unit:"æœ¬",expiry:daysFromNow(7),note:""},
    {id:6,name:"è±†è…",fridgeId:2,category:"other",qty:2,unit:"å€‹",expiry:daysFromNow(4),note:""},
    {id:7,name:"ãƒãƒ¼ã‚º",fridgeId:3,category:"dairy",qty:1,unit:"è¢‹",expiry:daysFromNow(14),note:""},
    {id:8,name:"å†·å‡ã†ã©ã‚“",fridgeId:3,category:"frozen",qty:3,unit:"å€‹",expiry:daysFromNow(30),note:""},
    {id:9,name:"ã‚‚ã‚„ã—",fridgeId:1,category:"vegetable",qty:1,unit:"è¢‹",expiry:daysFromNow(0),note:"ä»Šæ—¥ã¾ã§ï¼"},
  ],
  shopping: [
    {id:1,name:"é£Ÿãƒ‘ãƒ³",qty:"1è¢‹",done:false},
    {id:2,name:"ãƒ¨ãƒ¼ã‚°ãƒ«ãƒˆ",qty:"2å€‹",done:false},
  ],
  memoText: "",
  freq: {},
  activeFridge: null,
  searchQ: "",
  shopTab: "list",
  addItemOpen: false,
  addShopOpen: false,
  addForm: {name:"",fridgeId:1,category:"dairy",qty:1,unit:"å€‹",expiry:daysFromNow(7),note:""},
  shopForm: {name:"",qty:""},
  shopSugg: null,
  shopLoading: false,
  flyerResult: null,
  flyerLoading: false,
  flyerPreview: null,
  mealPlan: null,
  mealLoading: false,
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STORAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveState(){
  try{
    localStorage.setItem('reizouko_items', JSON.stringify(state.items));
    localStorage.setItem('reizouko_shop',  JSON.stringify(state.shopping));
    localStorage.setItem('reizouko_memo',  state.memoText);
    localStorage.setItem('reizouko_freq',  JSON.stringify(state.freq));
  }catch(e){}
}
function loadState(){
  try{
    const it=localStorage.getItem('reizouko_items');
    const sh=localStorage.getItem('reizouko_shop');
    const mo=localStorage.getItem('reizouko_memo');
    const fr=localStorage.getItem('reizouko_freq');
    if(it) state.items=JSON.parse(it);
    if(sh) state.shopping=JSON.parse(sh);
    if(mo) state.memoText=mo;
    if(fr) state.freq=JSON.parse(fr);
  }catch(e){}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render(){
  const urgent = state.items.filter(i=>daysLeft(i.expiry)<=3).sort((a,b)=>daysLeft(a.expiry)-daysLeft(b.expiry));
  // alert badge
  const badge=document.getElementById('alert-badge');
  if(urgent.length>0){badge.style.display='block';badge.textContent=`âš ï¸ ${urgent.length}ä»¶æœŸé™æ³¨æ„`}
  else{badge.style.display='none'}
  // nav
  ['home','items','shopping','meals'].forEach(t=>{
    document.getElementById('nav-'+t).className='nav-btn'+(state.tab===t?' active':'');
  });
  // main
  const main=document.getElementById('main-content');
  if(state.tab==='home')     main.innerHTML=renderHome(urgent);
  else if(state.tab==='items')    main.innerHTML=renderItems();
  else if(state.tab==='shopping') main.innerHTML=renderShopping();
  else if(state.tab==='meals')    main.innerHTML=renderMeals();
}

// â”€â”€ HOME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderHome(urgent){
  const total=state.items.length;
  const shopPending=state.shopping.filter(s=>!s.done).length;
  const fridgeCnt=id=>state.items.filter(i=>i.fridgeId===id).length;
  const fridgeUrg=id=>state.items.filter(i=>i.fridgeId===id&&daysLeft(i.expiry)<=3).length;

  let urgHtml='';
  if(urgent.length>0){
    urgHtml=`<div class="sec-title">ğŸ”´ ä»Šã™ãä½¿ã†ã¹ãé£Ÿæ</div>`;
    urgent.forEach(item=>{
      const d=daysLeft(item.expiry),col=expiryColor(d),cat=getCat(item.category),fr=getFridge(item.fridgeId);
      urgHtml+=`<div class="urg-row">
        <span style="font-size:22px">${cat.icon}</span>
        <div style="flex:1"><b>${esc(item.name)}</b><div style="font-size:11px;color:#aaa">${fr.icon} ${esc(fr.name)}</div></div>
        <div class="exp-badge" style="background:${col.bg};color:${col.tx}">${expiryLabel(d)}</div>
      </div>`;
    });
    urgHtml+=`<button class="btn-primary" style="width:100%;margin-top:4px;margin-bottom:8px" onclick="switchTab('meals');generateMeals()">ğŸ³ ã“ã®é£Ÿæã§çŒ®ç«‹ã‚’ä½œã‚‹</button>`;
  }

  return `<div class="fade">
    <div class="stats-row">
      <div class="stat-card card" style="border-top:3px solid #4fc3f7">
        <div class="stat-n">${total}</div><div class="stat-l">ç·åœ¨åº«</div>
      </div>
      <div class="stat-card card" style="border-top:3px solid #e53935" onclick="switchTab('items')">
        <div class="stat-n" style="color:${urgent.length>0?'#e53935':'inherit'}">${urgent.length}</div><div class="stat-l">æœŸé™é–“è¿‘</div>
      </div>
      <div class="stat-card card" style="border-top:3px solid #66bb6a">
        <div class="stat-n">${shopPending}</div><div class="stat-l">è²·ã„ç‰©ãƒªã‚¹ãƒˆ</div>
      </div>
    </div>
    <div class="sec-title">å†·è”µåº«ã®çŠ¶æ³</div>
    <div class="fridge-grid">
      ${FRIDGES.map(f=>`
        <div class="fridge-card card" style="border-color:${f.color}" onclick="setActiveFridge(${f.id})">
          <div class="fridge-ico" style="background:${f.color}22">${f.icon}</div>
          <div class="fridge-name">${f.name}</div>
          <div class="fridge-cnt">${fridgeCnt(f.id)}å“</div>
          ${fridgeUrg(f.id)>0?`<div class="fridge-warn">âš ï¸ ${fridgeUrg(f.id)}ä»¶</div>`:''}
        </div>`).join('')}
    </div>
    ${urgHtml}
  </div>`;
}

// â”€â”€ ITEMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderItems(){
  let list = state.activeFridge ? state.items.filter(i=>i.fridgeId===state.activeFridge) : state.items;
  if(state.searchQ) list=list.filter(i=>i.name.includes(state.searchQ)||i.note.includes(state.searchQ));
  list=list.slice().sort((a,b)=>daysLeft(a.expiry)-daysLeft(b.expiry));

  const itemsHtml = list.length===0
    ? `<div class="empty">åœ¨åº«ãŒã‚ã‚Šã¾ã›ã‚“<br><small>ä¸‹ã®ã€Œï¼‹ é£Ÿæã‚’è¿½åŠ ã€ã‹ã‚‰ç™»éŒ²ã—ã¦ãã ã•ã„</small></div>`
    : list.map(item=>{
        const d=daysLeft(item.expiry),col=expiryColor(d),cat=getCat(item.category),fr=getFridge(item.fridgeId);
        return `<div class="irow" style="${d<=2?'border-left:3px solid '+col.bg:''}">
          <div style="font-size:22px;width:32px;text-align:center;flex-shrink:0">${cat.icon}</div>
          <div style="flex:1;min-width:0">
            <div class="item-name">${esc(item.name)}</div>
            <div class="item-meta">
              <span style="color:${fr.dark}">${fr.icon} ${esc(fr.name)}</span>
              <span style="color:#ccc">Â·</span><span>${item.qty}${esc(item.unit)}</span>
              ${item.note?`<span style="color:#ccc">Â·</span><span style="color:#aaa">${esc(item.note)}</span>`:''}
            </div>
          </div>
          <div class="exp-badge" style="background:${col.bg};color:${col.tx}">${expiryLabel(d)}</div>
          <button class="xbtn" onclick="deleteItem(${item.id})">Ã—</button>
        </div>`;
      }).join('');

  const modalHtml = state.addItemOpen ? renderAddItemModal() : '';

  return `<div class="fade">
    <div class="filter-row">
      <button class="fbtn ${state.activeFridge===null?'factive':''}" onclick="setActiveFridge(null)">ã™ã¹ã¦</button>
      ${FRIDGES.map(f=>`<button class="fbtn ${state.activeFridge===f.id?'factive':''}" style="${state.activeFridge===f.id?`border-color:${f.color};background:${f.color}22;color:${f.dark}`:''}" onclick="setActiveFridge(${f.id})">${f.icon} ${f.name}</button>`).join('')}
    </div>
    <input class="sinput" placeholder="ğŸ” é£Ÿæã‚’æ¤œç´¢..." value="${esc(state.searchQ)}" oninput="updateSearch(this.value)">
    <div class="item-list">${itemsHtml}</div>
    <button class="fab" onclick="openAddItem()">ï¼‹ é£Ÿæã‚’è¿½åŠ </button>
    ${modalHtml}
  </div>`;
}

function renderAddItemModal(){
  const form=state.addForm;
  const presets=PRESETS[form.category]||[];
  const sortedPresets=[...presets].sort((a,b)=>(state.freq[b.name]||0)-(state.freq[a.name]||0));

  const presetsHtml=sortedPresets.map(p=>{
    const cnt=state.freq[p.name]||0;
    const sel=form.name===p.name;
    const cls=`preset-chip${sel?' selected':cnt>=3?' hot':cnt>=1?' used':''}`;
    return `<button class="${cls}" onclick="selectPreset('${esc(p.name)}','${esc(p.unit)}',${p.qty},${p.exp})">
      ${cnt>=3?'ğŸ”¥':cnt>=1?'â­':''}${esc(p.name)}${cnt>0?`<span style="font-size:10px;color:${sel?'rgba(255,255,255,.6)':'#bbb'}">${cnt}å›</span>`:''}
    </button>`;
  }).join('');

  const unitsHtml=UNITS.map(u=>`<option value="${u}"${form.unit===u?' selected':''}>${u}</option>`).join('');
  const fridgeBtns=FRIDGES.map(fr=>`<button onclick="setFormFridge(${fr.id})" style="flex:1;padding:8px 4px;border:2px solid ${form.fridgeId===fr.id?fr.color:'#e0dbd2'};border-radius:10px;background:${form.fridgeId===fr.id?fr.color+'22':'#fff'};cursor:pointer;font-size:12px;text-align:center;transition:all .2s">${fr.icon}<br><small>${fr.name}</small></button>`).join('');
  const catBtns=CATEGORIES.map(c=>`<button onclick="setFormCat('${c.id}')" style="padding:8px 12px;border-radius:20px;border:1.5px solid ${form.category===c.id?'#1a1a1a':'#e0dbd2'};background:${form.category===c.id?'#1a1a1a':'#fff'};color:${form.category===c.id?'#fff':'#555'};cursor:pointer;font-size:12px;transition:all .2s">${c.icon} ${c.label}</button>`).join('');

  return `<div class="overlay" onclick="closeAddItem()">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="m-title">é£Ÿæã‚’è¿½åŠ </div>

      <div class="lbl">â‘  ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ</div>
      <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:18px">${catBtns}</div>

      <div class="lbl">â‘¡ ã‚ˆãè²·ã†é£Ÿæã‹ã‚‰é¸ã¶ ${Object.keys(state.freq).length>0?'<span style="font-size:11px;color:#aaa;margin-left:4px">ğŸ”¥ è³¼å…¥å›æ•°é †</span>':''}</div>
      <div class="preset-wrap">${presetsHtml}</div>

      <div class="field">
        <label class="lbl">â‘¢ é£Ÿæåï¼ˆç›´æ¥å…¥åŠ›ã‚‚OKï¼‰</label>
        <input class="fi" placeholder="ä¾‹: ãã®ä»–ã®é£Ÿæå" value="${esc(form.name)}" oninput="setFormName(this.value)">
      </div>

      <div class="lbl">â‘£ å†·è”µåº«</div>
      <div style="display:flex;gap:8px;margin-bottom:14px">${fridgeBtns}</div>

      <div style="display:flex;gap:8px">
        <div class="field" style="flex:1">
          <label class="lbl">æ•°é‡</label>
          <input class="fi" type="number" min="0" value="${form.qty}" oninput="setFormQty(this.value)">
        </div>
        <div class="field" style="flex:1">
          <label class="lbl">å˜ä½</label>
          <select class="fi" onchange="setFormUnit(this.value)">${unitsHtml}</select>
        </div>
      </div>

      <div class="field">
        <label class="lbl">æ¶ˆè²»æœŸé™</label>
        <input class="fi" type="date" value="${form.expiry}" onchange="setFormExpiry(this.value)">
      </div>

      <div class="field">
        <label class="lbl">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
        <input class="fi" placeholder="ä¾‹: ã—ã‚ƒã¶ã—ã‚ƒã¶ç”¨" value="${esc(form.note)}" oninput="setFormNote(this.value)">
      </div>

      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn-ghost" style="flex:1" onclick="closeAddItem()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn-primary" style="flex:2" onclick="addItem()" ${!form.name.trim()?'disabled':''}>è¿½åŠ ã™ã‚‹</button>
      </div>
    </div>
  </div>`;
}

// â”€â”€ SHOPPING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderShopping(){
  const t=state.shopTab;
  let content='';

  if(t==='list'){
    const pending=state.shopping.filter(s=>!s.done).length;
    const suggHtml = state.shopLoading
      ? `<div class="load-box"><div class="spin"></div><p>åˆ†æä¸­...</p></div>`
      : state.shopSugg && !state.shopSugg.error
      ? `<div class="sugg-box">
          <div style="font-size:13px;font-weight:700;margin-bottom:12px;color:#555">ğŸ¤– AIã®è³¼å…¥ææ¡ˆ</div>
          ${state.shopSugg.items.map(s=>`
            <div style="display:flex;align-items:flex-start;gap:12px;padding:10px 0;border-bottom:1px solid #f5f5f5">
              <div style="flex:1">
                <b style="font-size:14px">${esc(s.name)}</b>
                <span class="p-badge" style="background:${s.priority==='é«˜'?'#ffebee':s.priority==='ä¸­'?'#fff8e1':'#f1f8e9'};color:${s.priority==='é«˜'?'#c62828':s.priority==='ä¸­'?'#f57f17':'#33691e'}">${s.priority}</span>
                <div style="font-size:12px;color:#888;margin-top:2px">${esc(s.reason)}</div>
              </div>
              <button class="btn-primary" style="font-size:12px;padding:6px 12px;flex-shrink:0" onclick="addSuggestedToShop('${esc(s.name)}')">è¿½åŠ </button>
            </div>`).join('')}
        </div>`
      : state.shopSugg?.error ? `<div class="err-box">ææ¡ˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>` : '';

    const listHtml = state.shopping.length===0
      ? `<div class="empty">ãƒªã‚¹ãƒˆã¯ç©ºã§ã™</div>`
      : state.shopping.map(s=>`
          <div class="irow" style="${s.done?'opacity:.45':''}">
            <input type="checkbox" ${s.done?'checked':''} onchange="toggleShop(${s.id})" style="width:20px;height:20px;cursor:pointer;flex-shrink:0">
            <div style="flex:1">
              <div style="font-size:14px;font-weight:600;text-decoration:${s.done?'line-through':'none'}">${esc(s.name)}</div>
              ${s.qty?`<div style="font-size:12px;color:#aaa">${esc(s.qty)}</div>`:''}
            </div>
            <button class="xbtn" onclick="deleteShop(${s.id})">Ã—</button>
          </div>`).join('');

    content=`
      <div style="display:flex;gap:8px;margin-bottom:14px">
        <button class="btn-primary" style="flex:1" onclick="getShopSugg()" ${state.shopLoading?'disabled':''}>ğŸ¤– AIææ¡ˆ</button>
        <button class="btn-ghost" onclick="openAddShop()">ï¼‹ è¿½åŠ </button>
      </div>
      ${suggHtml}
      <div class="sec-title">è²·ã„ç‰©ãƒªã‚¹ãƒˆï¼ˆ${pending}ä»¶æœªè³¼å…¥ï¼‰</div>
      <div class="item-list">${listHtml}</div>
      ${state.shopping.filter(s=>s.done).length>0?`<button class="btn-ghost" style="width:100%;margin-top:8px" onclick="clearDoneShop()">âœ“ è³¼å…¥æ¸ˆã¿ã‚’ã‚¯ãƒªã‚¢</button>`:''}
      ${state.addShopOpen?renderAddShopModal():''}`;
  }

  else if(t==='flyer'){
    const resultHtml = state.flyerLoading
      ? `<div class="load-box"><div class="spin"></div><p>ãƒãƒ©ã‚·ã‚’è§£æä¸­...</p></div>`
      : state.flyerResult && !state.flyerResult.error
      ? `${state.flyerResult.summary?`<div style="background:#e8f5e9;border-radius:12px;padding:12px;margin-bottom:12px;font-size:13px">ğŸ“‹ <b>ãƒãƒ©ã‚·æ¦‚è¦ï¼š</b>${esc(state.flyerResult.summary)}</div>`:''}
         ${state.flyerResult.bestDeal?`<div style="background:#fff8e1;border-radius:12px;padding:12px;margin-bottom:12px;font-size:13px">ğŸ† <b>æœ€ã‚‚ãŠå¾—ï¼š</b>${esc(state.flyerResult.bestDeal)}</div>`:''}
         <div class="sec-title">å•†å“ãƒªã‚¹ãƒˆ</div>
         ${(state.flyerResult.items||[]).map(item=>`
           <div class="flyer-item" style="border-left:${item.recommend?'3px solid #f57c00':'3px solid transparent'}">
             <div style="flex:1">
               <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
                 <span style="font-size:14px;font-weight:600">${esc(item.name)}</span>
                 ${item.recommend?`<span style="font-size:11px;background:#fff3e0;color:#e65100;padding:2px 8px;border-radius:20px;font-weight:600">ğŸ”¥ ãŠã™ã™ã‚</span>`:''}
                 ${item.discount?`<span style="font-size:11px;background:#fce4ec;color:#c62828;padding:2px 8px;border-radius:20px;font-weight:600">${esc(item.discount)}</span>`:''}
               </div>
               <div style="display:flex;gap:8px;margin-top:4px;align-items:center">
                 <span style="font-size:16px;font-weight:700;color:#c62828">${esc(item.price)}</span>
                 ${item.originalPrice?`<span style="font-size:12px;color:#aaa;text-decoration:line-through">${esc(item.originalPrice)}</span>`:''}
               </div>
               ${item.reason?`<div style="font-size:12px;color:#888;margin-top:2px">${esc(item.reason)}</div>`:''}
             </div>
             <button class="btn-primary" style="font-size:12px;padding:6px 10px;flex-shrink:0" onclick="addFlyerToShop('${esc(item.name)}')">ãƒªã‚¹ãƒˆè¿½åŠ </button>
           </div>`).join('')}`
      : state.flyerResult?.error
      ? `<div class="err-box">è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚åˆ¥ã®å†™çœŸã§è©¦ã—ã¦ãã ã•ã„ã€‚</div>`
      : `<div class="empty"><div style="font-size:14px">å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨<br>AIãŒãƒãƒ©ã‚·ã‚’è§£æã—ã¦<br>ãŠå¾—ãªå•†å“ã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã™</div></div>`;

    const previewHtml = state.flyerPreview
      ? `<img src="${state.flyerPreview}" style="max-width:100%;max-height:200px;border-radius:10px;object-fit:contain;display:block;margin-bottom:12px">`
      : '';

    content=`
      <div class="flyer-upload" onclick="document.getElementById('flyer-input').click()">
        ${previewHtml}
        <div style="font-size:40px;margin-bottom:8px">ğŸ“¸</div>
        <div style="font-size:15px;font-weight:600">${state.flyerPreview?'åˆ¥ã®å†™çœŸã«å¤‰æ›´':'ãƒãƒ©ã‚·ã®å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰'}</div>
        <div style="font-size:12px;color:#aaa;margin-top:4px">ã‚¿ãƒƒãƒ—ã—ã¦æ’®å½± or ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ</div>
      </div>
      <input type="file" id="flyer-input" accept="image/*" style="display:none" onchange="handleFlyerFile(this)">
      ${resultHtml}`;
  }

  else if(t==='memo'){
    content=`
      <div style="font-size:13px;color:#888;margin-bottom:10px">âœï¸ ä»Šæ—¥ã®è²·ã„ç‰©ãƒ¡ãƒ¢ â€” è‡ªç”±ã«æ›¸ãè¾¼ã‚ã¾ã™</div>
      <textarea class="memo-area" oninput="updateMemo(this.value)" placeholder="ä¾‹ï¼š&#10;ãƒ»ç‰›ä¹³ Ã— 2æœ¬&#10;ãƒ»åµï¼ˆç‰¹å£²ã®ã¨ãï¼‰&#10;ãƒ»å¤•é£Ÿç”¨ã®é¶è‚‰&#10;&#10;â€» è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™">${esc(state.memoText)}</textarea>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn-ghost" style="flex:1" onclick="clearMemo()">ğŸ—‘ ã‚¯ãƒªã‚¢</button>
        <button class="btn-primary" style="flex:2" onclick="memoToList()">ğŸ“‹ ãƒªã‚¹ãƒˆã«å¤‰æ›</button>
      </div>
      <div style="font-size:12px;color:#bbb;margin-top:8px;text-align:center">è‡ªå‹•ä¿å­˜ Â· ãƒ‡ãƒ¼ã‚¿ã¯ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™</div>`;
  }

  return `<div class="fade">
    <div class="subtabs">
      <button class="stab ${t==='list'?'stactive':''}" onclick="setShopTab('list')">ğŸ“‹ ãƒªã‚¹ãƒˆ</button>
      <button class="stab ${t==='flyer'?'stactive':''}" onclick="setShopTab('flyer')">ğŸ“¸ ãƒãƒ©ã‚·èª­å–</button>
      <button class="stab ${t==='memo'?'stactive':''}" onclick="setShopTab('memo')">âœï¸ ãƒ¡ãƒ¢</button>
    </div>
    ${content}
  </div>`;
}

function renderAddShopModal(){
  return `<div class="overlay" onclick="closeAddShop()">
    <div class="modal" style="max-width:340px;margin:0 auto" onclick="event.stopPropagation()">
      <div class="m-title">ãƒªã‚¹ãƒˆã«è¿½åŠ </div>
      <div class="field"><label class="lbl">å“å</label><input class="fi" id="shop-name-input" placeholder="ä¾‹: åµ" value="${esc(state.shopForm.name)}" oninput="state.shopForm.name=this.value"></div>
      <div class="field"><label class="lbl">æ•°é‡ï¼ˆä»»æ„ï¼‰</label><input class="fi" placeholder="ä¾‹: 1ãƒ‘ãƒƒã‚¯" value="${esc(state.shopForm.qty)}" oninput="state.shopForm.qty=this.value"></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn-ghost" style="flex:1" onclick="closeAddShop()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn-primary" style="flex:2" onclick="addShopItem()">è¿½åŠ </button>
      </div>
    </div>
  </div>`;
}

// â”€â”€ MEALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMeals(){
  const urgent=state.items.filter(i=>daysLeft(i.expiry)<=3);
  const urgText=urgent.map(i=>`${i.name}ï¼ˆ${expiryLabel(daysLeft(i.expiry))}ï¼‰`).join('ã€€');

  const planHtml = state.mealLoading
    ? `<div class="load-box"><div class="spin"></div><p>çŒ®ç«‹ã‚’ç”Ÿæˆä¸­...</p></div>`
    : state.mealPlan && !state.mealPlan.error
    ? `<div>
        ${(state.mealPlan.days||[]).map(day=>`
          <div class="day-card">
            <div style="font-size:14px;font-weight:700;color:#555;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid #f0ede8">${esc(day.day)}</div>
            ${(day.meals||[]).map(meal=>`
              <div class="meal-row">
                <div style="font-size:11px;font-weight:700;color:#aaa;width:36px;padding-top:2px;flex-shrink:0">${esc(meal.type)}</div>
                <div style="flex:1">
                  <div style="font-size:14px;font-weight:600;display:flex;align-items:center;gap:8px;flex-wrap:wrap">
                    ${esc(meal.name)}
                    ${meal.urgent?`<span style="font-size:11px;background:#fff3e0;color:#e65100;padding:2px 8px;border-radius:20px">ğŸ”¥ æœŸé™å„ªå…ˆ</span>`:''}
                  </div>
                  <div style="font-size:12px;color:#888;margin-top:3px">${(meal.ingredients||[]).map(esc).join('ãƒ»')}</div>
                  <div style="font-size:11px;color:#aaa">â± ${esc(meal.time)}</div>
                </div>
              </div>`).join('')}
          </div>`).join('')}
        ${state.mealPlan.tips?`<div style="background:#f0fdf4;border:1px solid #a5d6a7;border-radius:12px;padding:14px"><b>ğŸ’¡ ã‚¢ãƒ‰ãƒã‚¤ã‚¹</b><p style="margin-top:6px;font-size:13px;line-height:1.6">${esc(state.mealPlan.tips)}</p></div>`:''}
      </div>`
    : state.mealPlan?.error
    ? `<div class="err-box">çŒ®ç«‹ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚</div>`
    : `<div class="empty"><div style="font-size:48px;margin-bottom:12px">ğŸ½ï¸</div><div>ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦AIã«<br>çŒ®ç«‹ã‚’ææ¡ˆã—ã¦ã‚‚ã‚‰ã„ã¾ã—ã‚‡ã†</div></div>`;

  return `<div class="fade">
    <button class="btn-primary" style="width:100%;padding:14px;font-size:15px;margin-bottom:8px" onclick="generateMeals()" ${state.mealLoading?'disabled':''}>
      ${state.mealLoading?'â³ çŒ®ç«‹ã‚’è€ƒãˆã¦ã„ã¾ã™...':'ğŸ¤– AIã§3æ—¥é–“ã®çŒ®ç«‹ã‚’ç”Ÿæˆ'}
    </button>
    <p style="font-size:12px;color:#aaa;text-align:center;margin-bottom:16px">æœŸé™é–“è¿‘ã®é£Ÿæã‚’å„ªå…ˆã—ã¦çŒ®ç«‹ã‚’ææ¡ˆã—ã¾ã™</p>
    ${urgent.length>0?`<div style="background:#fff3e0;border-radius:12px;padding:12px;font-size:13px;margin-bottom:16px;line-height:1.7"><b>âš ï¸ æœŸé™é–“è¿‘ï¼š</b>${urgText}</div>`:''}
    ${planHtml}
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(t){state.tab=t;render()}
function setActiveFridge(id){state.activeFridge=id;state.tab='items';render()}
function updateSearch(v){state.searchQ=v;render()}

function openAddItem(){state.addItemOpen=true;render();setTimeout(()=>document.querySelector('.modal')?.scrollTo(0,0),50)}
function closeAddItem(){state.addItemOpen=false;render()}
function selectPreset(name,unit,qty,expDays){
  state.addForm={...state.addForm,name,unit,qty,expiry:daysFromNow(expDays)};render();
}
function setFormCat(c){state.addForm={...state.addForm,category:c,name:"",unit:"å€‹",qty:1};render()}
function setFormFridge(id){state.addForm={...state.addForm,fridgeId:id};render()}
function setFormName(v){state.addForm.name=v}
function setFormQty(v){state.addForm.qty=v}
function setFormUnit(v){state.addForm.unit=v}
function setFormExpiry(v){state.addForm.expiry=v}
function setFormNote(v){state.addForm.note=v}
function addItem(){
  const f=state.addForm;
  if(!f.name.trim())return;
  state.items.push({id:Date.now(),name:f.name,fridgeId:f.fridgeId,category:f.category,qty:Number(f.qty),unit:f.unit,expiry:f.expiry,note:f.note});
  state.freq[f.name]=(state.freq[f.name]||0)+1;
  state.addForm={name:"",fridgeId:1,category:"dairy",qty:1,unit:"å€‹",expiry:daysFromNow(7),note:""};
  state.addItemOpen=false;
  saveState();render();
}
function deleteItem(id){state.items=state.items.filter(i=>i.id!==id);saveState();render()}

function setShopTab(t){state.shopTab=t;render()}
function openAddShop(){state.addShopOpen=true;render()}
function closeAddShop(){state.addShopOpen=false;render()}
function addShopItem(){
  const n=state.shopForm.name;if(!n.trim())return;
  state.shopping.push({id:Date.now(),name:n,qty:state.shopForm.qty,done:false});
  state.shopForm={name:"",qty:""};
  state.addShopOpen=false;saveState();render();
}
function addSuggestedToShop(name){
  if(!state.shopping.find(s=>s.name===name)) state.shopping.push({id:Date.now(),name,qty:"",done:false});
  saveState();render();
}
function addFlyerToShop(name){
  addSuggestedToShop(name);
  state.shopTab='list';render();
}
function toggleShop(id){state.shopping=state.shopping.map(s=>s.id===id?{...s,done:!s.done}:s);saveState();render()}
function deleteShop(id){state.shopping=state.shopping.filter(s=>s.id!==id);saveState();render()}
function clearDoneShop(){state.shopping=state.shopping.filter(s=>!s.done);saveState();render()}
function updateMemo(v){state.memoText=v;saveState()}
function clearMemo(){state.memoText="";saveState();render()}
function memoToList(){
  const lines=state.memoText.split('\n').map(l=>l.replace(/^[ãƒ»\-\*\s]+/,'').trim()).filter(Boolean);
  lines.forEach(l=>{if(!state.shopping.find(s=>s.name===l))state.shopping.push({id:Date.now()+Math.random(),name:l,qty:"",done:false})});
  state.shopTab='list';saveState();render();
}

function showHelp(){document.getElementById('help-overlay').style.display='block'}
function hideHelp(){document.getElementById('help-overlay').style.display='none'}

// â”€â”€ FLYER â”€â”€
function handleFlyerFile(input){
  const file=input.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=async(ev)=>{
    const dataUrl=ev.target.result;
    state.flyerPreview=dataUrl;
    const base64=dataUrl.split(',')[1];
    const mime=file.type||'image/jpeg';
    state.flyerLoading=true;state.flyerResult=null;render();
    try{
      const stock=state.items.map(i=>i.name).join('ã€');
      const res=await fetch('https://api.anthropic.com/v1/messages',{
        method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:900,messages:[{role:'user',content:[
          {type:'image',source:{type:'base64',media_type:mime,data:base64}},
          {type:'text',text:`ã“ã®ãƒãƒ©ã‚·ã‚’åˆ†æã€‚å†·è”µåº«åœ¨åº«ï¼š${stock||'ãªã—'}\nJSONå½¢å¼ã®ã¿ã§å›ç­”ï¼š{"items":[{"name":"å•†å“å","price":"Â¥000","originalPrice":"Â¥000","discount":"30%OFF","recommend":true,"reason":"ç†ç”±"}],"summary":"æ¦‚è¦","bestDeal":"æœ€ã‚‚ãŠå¾—"}`}
        ]}]})
      });
      const d=await res.json();
      const txt=d.content?.map(b=>b.text||'').join('').replace(/```json|```/g,'').trim();
      state.flyerResult=JSON.parse(txt);
    }catch(e){state.flyerResult={error:true}}
    state.flyerLoading=false;render();
  };
  reader.readAsDataURL(file);
}

// â”€â”€ AI SHOP SUGGEST â”€â”€
async function getShopSugg(){
  state.shopLoading=true;state.shopSugg=null;render();
  try{
    const s=state.items.map(i=>`${i.name} ${i.qty}${i.unit}`).join('ã€');
    const res=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:600,messages:[{role:'user',content:`åœ¨åº«ï¼š${s||'ãªã—'}\nä¸è¶³é£Ÿæã‚’ææ¡ˆã€‚JSONï¼š{"items":[{"name":"åå‰","reason":"ç†ç”±","priority":"é«˜/ä¸­/ä½"}]}`}]})
    });
    const d=await res.json();
    const txt=d.content?.map(b=>b.text||'').join('').replace(/```json|```/g,'').trim();
    state.shopSugg=JSON.parse(txt);
  }catch(e){state.shopSugg={error:true}}
  state.shopLoading=false;render();
}

// â”€â”€ AI MEALS â”€â”€
async function generateMeals(){
  state.mealLoading=true;state.mealPlan=null;render();
  try{
    const urgent=state.items.filter(i=>daysLeft(i.expiry)<=3);
    const u=urgent.map(i=>`${i.name}ï¼ˆ${expiryLabel(daysLeft(i.expiry))}ï¼‰`).join('ã€');
    const a=state.items.map(i=>i.name).join('ã€');
    const res=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:1000,messages:[{role:'user',content:`æ–™ç†å°‚é–€å®¶ã¨ã—ã¦å†·è”µåº«ã®é£Ÿæã§çŒ®ç«‹ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚\nã€ä»Šã™ãä½¿ã†ã¹ãé£Ÿæã€‘${u||'ãªã—'}\nã€å…¨åœ¨åº«ã€‘${a}\næœŸé™é–“è¿‘ã‚’å„ªå…ˆã—ã¦3æ—¥åˆ†ã®æœæ˜¼å¤•ã‚’ææ¡ˆã€‚\nJSONå½¢å¼ã®ã¿ï¼š{"days":[{"day":"ä»Šæ—¥","meals":[{"type":"æœé£Ÿ","name":"æ–™ç†å","ingredients":["é£Ÿæ"],"time":"15åˆ†","urgent":true},...]},...], "tips":"ã‚¢ãƒ‰ãƒã‚¤ã‚¹"}`}]})
    });
    const d=await res.json();
    const txt=d.content?.map(b=>b.text||'').join('').replace(/```json|```/g,'').trim();
    state.mealPlan=JSON.parse(txt);
  }catch(e){state.mealPlan={error:true}}
  state.mealLoading=false;render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
loadState();
render();
</script>
</body>
</html>
